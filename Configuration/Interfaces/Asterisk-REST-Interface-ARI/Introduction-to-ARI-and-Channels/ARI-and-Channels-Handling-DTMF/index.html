<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://docs.asterisk.org/Configuration/Interfaces/Asterisk-REST-Interface-ARI/Introduction-to-ARI-and-Channels/ARI-and-Channels-Handling-DTMF/ rel=canonical><link href=../ rel=prev><link href=../ARI-and-Channels-Manipulating-Channel-State/ rel=next><link rel=icon href=../../../../../favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.19"><title>Handling DTMF events - Asterisk Documentation</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../../material-override.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-2ZKMCW9DZ9"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-2ZKMCW9DZ9",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-2ZKMCW9DZ9",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#handling-dtmf-events class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title="Asterisk Documentation" class="md-header__button md-logo" aria-label="Asterisk Documentation" data-md-component=logo> <img src=../../../../../favicon.ico alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Asterisk Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Handling DTMF events </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <table border=0 style="width: max-content;padding:0px;margin:0px"><tr><td> <a href=https://github.com/asterisk/asterisk title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> Asterisk </div> </a> </td> <td style=font-size:.65rem;line-height:1.2;vertical-align:middle;> <a href=/About-the-Project/Asterisk-Versions>Asterisk Versions</a><br> <a target=_blank href=https://github.com/asterisk/documentation/issues>Report Documentation Issues</a><br> <a target=_blank href=https://github.com/asterisk/documentation>Contribute to the Documentation</a> </td></tr> </table> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="Asterisk Documentation" class="md-nav__button md-logo" aria-label="Asterisk Documentation" data-md-component=logo> <img src=../../../../../favicon.ico alt=logo> </a> Asterisk Documentation </label> <div class=md-nav__source> <table border=0 style="width: max-content;padding:0px;margin:0px"><tr><td> <a href=https://github.com/asterisk/asterisk title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> Asterisk </div> </a> </td> <td style=font-size:.65rem;line-height:1.2;vertical-align:middle;> <a href=/About-the-Project/Asterisk-Versions>Asterisk Versions</a><br> <a target=_blank href=https://github.com/asterisk/documentation/issues>Report Documentation Issues</a><br> <a target=_blank href=https://github.com/asterisk/documentation>Contribute to the Documentation</a> </td></tr> </table> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../About-the-Project/ class=md-nav__link> <span class=md-ellipsis> About the Project </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk-Community/ class=md-nav__link> <span class=md-ellipsis> Asterisk Community </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Fundamentals/ class=md-nav__link> <span class=md-ellipsis> Fundamentals </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Getting-Started/Beginning-Asterisk/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <div class="md-nav__link md-nav__container"> <a href=../../../../ class="md-nav__link "> <span class=md-ellipsis> Configuration </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Core-Configuration/ class=md-nav__link> <span class=md-ellipsis> Core Configuration </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Channel-Drivers/ class=md-nav__link> <span class=md-ellipsis> Channel Drivers </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Dialplan/ class=md-nav__link> <span class=md-ellipsis> Dialplan </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Applications/ class=md-nav__link> <span class=md-ellipsis> Applications </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Functions/ class=md-nav__link> <span class=md-ellipsis> Functions </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Features/ class=md-nav__link> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8 checked> <div class="md-nav__link md-nav__container"> <a href=../../../ class="md-nav__link "> <span class=md-ellipsis> Interfaces </span> </a> <label class="md-nav__link " for=__nav_5_8 id=__nav_5_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=true> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Interfaces </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../Asterisk-Manager-Interface-AMI/ class=md-nav__link> <span class=md-ellipsis> Asterisk Manager Interface AMI </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8_3 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> Asterisk REST Interface ARI </span> </a> <label class="md-nav__link " for=__nav_5_8_3 id=__nav_5_8_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_5_8_3_label aria-expanded=true> <label class=md-nav__title for=__nav_5_8_3> <span class="md-nav__icon md-icon"></span> Asterisk REST Interface ARI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ARI-Libraries/ class=md-nav__link> <span class=md-ellipsis> ARI Libraries </span> </a> </li> <li class=md-nav__item> <a href=../../ARI-Outbound-Websockets/ class=md-nav__link> <span class=md-ellipsis> ARI Outbound Websockets </span> </a> </li> <li class=md-nav__item> <a href=../../ARI-REST-over-WebSocket/ class=md-nav__link> <span class=md-ellipsis> ARI REST over Websocket </span> </a> </li> <li class=md-nav__item> <a href=../../ARI-Versioning/ class=md-nav__link> <span class=md-ellipsis> ARI Versioning </span> </a> </li> <li class=md-nav__item> <a href=../../Asterisk-Configuration-for-ARI/ class=md-nav__link> <span class=md-ellipsis> Asterisk Configuration for ARI </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Getting-Started-with-ARI/ class=md-nav__link> <span class=md-ellipsis> Getting Started with ARI </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Introduction-to-ARI-Transfer-Handling/ class=md-nav__link> <span class=md-ellipsis> Introduction to ARI Transfer Handling </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Introduction-to-ARI-and-Bridges/ class=md-nav__link> <span class=md-ellipsis> Introduction to ARI and Bridges </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8_3_10 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Introduction to ARI and Channels </span> </a> <label class="md-nav__link " for=__nav_5_8_3_10 id=__nav_5_8_3_10_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_5_8_3_10_label aria-expanded=true> <label class=md-nav__title for=__nav_5_8_3_10> <span class="md-nav__icon md-icon"></span> Introduction to ARI and Channels </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Handling DTMF events </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Handling DTMF events </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#example-a-simple-automated-attendant class=md-nav__link> <span class=md-ellipsis> Example: A simple automated attendant </span> </a> <nav class=md-nav aria-label="Example: A simple automated attendant"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#dialplan class=md-nav__link> <span class=md-ellipsis> Dialplan </span> </a> </li> <li class=md-nav__item> <a href=#python class=md-nav__link> <span class=md-ellipsis> Python </span> </a> <nav class=md-nav aria-label=Python> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playing-the-menu class=md-nav__link> <span class=md-ellipsis> Playing the menu </span> </a> </li> <li class=md-nav__item> <a href=#cancelling-the-menu class=md-nav__link> <span class=md-ellipsis> Cancelling the menu </span> </a> </li> <li class=md-nav__item> <a href=#timing-out class=md-nav__link> <span class=md-ellipsis> Timing out </span> </a> </li> <li class=md-nav__item> <a href=#handling-the-dtmf-options class=md-nav__link> <span class=md-ellipsis> Handling the DTMF options </span> </a> </li> <li class=md-nav__item> <a href=#channel-aapy class=md-nav__link> <span class=md-ellipsis> channel-aa.py </span> </a> </li> <li class=md-nav__item> <a href=#channel-aapy-in-action class=md-nav__link> <span class=md-ellipsis> channel-aa.py in action </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#javascript-nodejs class=md-nav__link> <span class=md-ellipsis> JavaScript (Node.js) </span> </a> <nav class=md-nav aria-label="JavaScript (Node.js)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playing-the-menu_1 class=md-nav__link> <span class=md-ellipsis> Playing the menu </span> </a> </li> <li class=md-nav__item> <a href=#cancelling-the-menu_1 class=md-nav__link> <span class=md-ellipsis> Cancelling the menu </span> </a> </li> <li class=md-nav__item> <a href=#timing-out_1 class=md-nav__link> <span class=md-ellipsis> Timing out </span> </a> </li> <li class=md-nav__item> <a href=#handling-the-dtmf-options_1 class=md-nav__link> <span class=md-ellipsis> Handling the DTMF options </span> </a> </li> <li class=md-nav__item> <a href=#channel-aajs class=md-nav__link> <span class=md-ellipsis> channel-aa.js </span> </a> </li> <li class=md-nav__item> <a href=#channel-aajs-in-action class=md-nav__link> <span class=md-ellipsis> channel-aa.js in action </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ARI-and-Channels-Manipulating-Channel-State/ class=md-nav__link> <span class=md-ellipsis> Channel State </span> </a> </li> <li class=md-nav__item> <a href=../ARI-and-Channels-Simple-Media-Manipulation/ class=md-nav__link> <span class=md-ellipsis> Simple media playback </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../Introduction-to-ARI-and-Media-Manipulation/ class=md-nav__link> <span class=md-ellipsis> Introduction to ARI and Media Manipulation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../The-Asterisk-Resource/ class=md-nav__link> <span class=md-ellipsis> The Asterisk Resource </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../Asterisk-Gateway-Interface-AGI/ class=md-nav__link> <span class=md-ellipsis> Asterisk Gateway Interface (AGI) </span> </a> </li> <li class=md-nav__item> <a href=../../../Asterisk-External-Application-Protocol-AEAP/ class=md-nav__link> <span class=md-ellipsis> Asterisk External Application Protocol (AEAP) </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../Back-end-Database-and-Realtime-Connectivity/ class=md-nav__link> <span class=md-ellipsis> Back end Database and Realtime Connectivity </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../Distributed-Device-State/ class=md-nav__link> <span class=md-ellipsis> Distributed Device State </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../Asterisk-Call-Files/ class=md-nav__link> <span class=md-ellipsis> Asterisk Call Files </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../Asterisk-Calendaring/ class=md-nav__link> <span class=md-ellipsis> Asterisk Calendaring </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../Utilizing-the-StatsD-Dialplan-Application/ class=md-nav__link> <span class=md-ellipsis> Utilizing the StatsD Dialplan Application </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Reporting/ class=md-nav__link> <span class=md-ellipsis> Reporting </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../Miscellaneous/ class=md-nav__link> <span class=md-ellipsis> Miscellaneous </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../WebRTC/ class=md-nav__link> <span class=md-ellipsis> WebRTC </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../../Codec-Opus/ class=md-nav__link> <span class=md-ellipsis> Codec Opus </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Deployment/ class=md-nav__link> <span class=md-ellipsis> Deployment </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Operation/ class=md-nav__link> <span class=md-ellipsis> Operation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Development/ class=md-nav__link> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Latest_API/ class=md-nav__link> <span class=md-ellipsis> Latest API </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk_18_Documentation/ class=md-nav__link> <span class=md-ellipsis> Asterisk 18 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk_19_Documentation/ class=md-nav__link> <span class=md-ellipsis> Asterisk 19 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk_20_Documentation/ class=md-nav__link> <span class=md-ellipsis> Asterisk 20 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk_21_Documentation/ class=md-nav__link> <span class=md-ellipsis> Asterisk 21 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk_22_Documentation/ class=md-nav__link> <span class=md-ellipsis> Asterisk 22 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Asterisk_23_Documentation/ class=md-nav__link> <span class=md-ellipsis> Asterisk 23 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Certified-Asterisk_18.9_Documentation/ class=md-nav__link> <span class=md-ellipsis> Certified Asterisk 18.9 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Certified-Asterisk_20.7_Documentation/ class=md-nav__link> <span class=md-ellipsis> Certified Asterisk 20.7 Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Test-Suite-Documentation/ class=md-nav__link> <span class=md-ellipsis> Test Suite Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../../Historical-Documentation/ class=md-nav__link> <span class=md-ellipsis> Historical Documentation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../../../../Contributing-to-the-Documentation/ class=md-nav__link> <span class=md-ellipsis> Contributing to the Documentation </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#example-a-simple-automated-attendant class=md-nav__link> <span class=md-ellipsis> Example: A simple automated attendant </span> </a> <nav class=md-nav aria-label="Example: A simple automated attendant"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#dialplan class=md-nav__link> <span class=md-ellipsis> Dialplan </span> </a> </li> <li class=md-nav__item> <a href=#python class=md-nav__link> <span class=md-ellipsis> Python </span> </a> <nav class=md-nav aria-label=Python> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playing-the-menu class=md-nav__link> <span class=md-ellipsis> Playing the menu </span> </a> </li> <li class=md-nav__item> <a href=#cancelling-the-menu class=md-nav__link> <span class=md-ellipsis> Cancelling the menu </span> </a> </li> <li class=md-nav__item> <a href=#timing-out class=md-nav__link> <span class=md-ellipsis> Timing out </span> </a> </li> <li class=md-nav__item> <a href=#handling-the-dtmf-options class=md-nav__link> <span class=md-ellipsis> Handling the DTMF options </span> </a> </li> <li class=md-nav__item> <a href=#channel-aapy class=md-nav__link> <span class=md-ellipsis> channel-aa.py </span> </a> </li> <li class=md-nav__item> <a href=#channel-aapy-in-action class=md-nav__link> <span class=md-ellipsis> channel-aa.py in action </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#javascript-nodejs class=md-nav__link> <span class=md-ellipsis> JavaScript (Node.js) </span> </a> <nav class=md-nav aria-label="JavaScript (Node.js)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playing-the-menu_1 class=md-nav__link> <span class=md-ellipsis> Playing the menu </span> </a> </li> <li class=md-nav__item> <a href=#cancelling-the-menu_1 class=md-nav__link> <span class=md-ellipsis> Cancelling the menu </span> </a> </li> <li class=md-nav__item> <a href=#timing-out_1 class=md-nav__link> <span class=md-ellipsis> Timing out </span> </a> </li> <li class=md-nav__item> <a href=#handling-the-dtmf-options_1 class=md-nav__link> <span class=md-ellipsis> Handling the DTMF options </span> </a> </li> <li class=md-nav__item> <a href=#channel-aajs class=md-nav__link> <span class=md-ellipsis> channel-aa.js </span> </a> </li> <li class=md-nav__item> <a href=#channel-aajs-in-action class=md-nav__link> <span class=md-ellipsis> channel-aa.js in action </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=handling-dtmf-events>Handling DTMF events<a class=headerlink href=#handling-dtmf-events title="Permanent link">&para;</a></h1> <p>DTMF events are conveyed via the <a href=/Latest_API/API_Documentation/Asterisk_REST_Interface/Asterisk_REST_Data_Models/#channeldtmfreceived><code>ChannelDtmfReceived</code></a> event. The event contains the channel that pressed the DTMF key, the digit that was pressed, and the duration of the digit.</p> <p>While this concept is relatively straight forward, handling DTMF is quite common in applications, as it is the primary mechanism that phones have to inform a server to perform some action. This includes manipulating media, initiating call features, performing transfers, dialling, and just about every thing in between. As such, the examples on this page focus less on simply handling the event and more on using the DTMF in a relatively realistic fashion.</p> <h2 id=example-a-simple-automated-attendant>Example: A simple automated attendant<a class=headerlink href=#example-a-simple-automated-attendant title="Permanent link">&para;</a></h2> <p>This example mimics the <a href=/Deployment/Basic-PBX-Functionality/Auto-attendant-and-IVR-Menus/Handling-Special-Extensions>automated attendant/IVR dialplan example</a>. It does the following:</p> <ul> <li>Plays a menu to the user which is cancelled when the user takes some action.</li> <li>If the user presses <kbd>1</kbd> or <kbd>2</kbd>, the digit is repeated to the user and the menu restarted.</li> <li>If the user presses an invalid digit, a prompt informing the user that the digit was invalid is played to the user and the menu restarted.</li> <li>If the user fails to press anything within some period of time, a prompt asking the user if they are still present is played to the user and the menu restarted.</li> </ul> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>For this example, you will need the following:</p> <ol type=1> <li>The <strong>extra</strong> sound package from Asterisk. You can install this using the <code>menuselect</code> tool.</li> <li>If using the Python example, <code>ari-py</code> version 0.1.3 or later.</li> <li>If using the JavaScript example, ari-client version 0.1.4 or later.</li> </ol> </div> <h3 id=dialplan>Dialplan<a class=headerlink href=#dialplan title="Permanent link">&para;</a></h3> <p>As usual, a very simple dialplan is sufficient for this example. The dialplan takes the channel and places it into the Stasis application <code>channel-aa</code>.</p> <p>extensions.conf:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>exten =&gt; 1000,1,NoOp()
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a> same =&gt; n,Stasis(channel-aa)
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a> same =&gt; n,Hangup()
</span></code></pre></div> <h3 id=python>Python<a class=headerlink href=#python title="Permanent link">&para;</a></h3> <p>As this example is a bit larger, how the code is written and structured is broken up into two phases:</p> <ol type=1> <li>Constructing the menu and handling its state as the user presses buttons.</li> <li>Actually handling the button presses from the user.</li> </ol> <p>The full source code for this example immediately follows the walk through.</p> <h4 id=playing-the-menu>Playing the menu<a class=headerlink href=#playing-the-menu title="Permanent link">&para;</a></h4> <p>Unlike Playback, which can chain multiple sounds together and play them back in one continuous operation, ARI treats all sound files being played as separate operations. It will queue each sound file up to be played on the channel, and hand back the caller an object to control the operation of that single sound file. The menu announcement for the attendant has the following requirements:</p> <ol type=1> <li>Playback the options for the user</li> <li>If the user presses a DTMF key, cancel the playback of the options and handle the request</li> <li>If the user presses an invalid DTMF key, let them know and restart the menu</li> <li>If the user doesn't press anything, wait 10 seconds, ask them if they are still present, and restart the menu</li> </ol> <p>The second requirement makes this a bit more challenging: when the user presses a DTMF key, we want to cancel whatever sound file is currently being played back and immediately handle their request. We thus have to maintain some state in our application about what sound file is currently being played so that we can cancel the correct playback. We also don't want to queue up all of the sounds immediately - we'd have to walk through all of the queued up sounds and cancel each one - that'd be annoying! Instead, we only want to start the next sound in our prompt when the previous has completed.</p> <p>To start, we'll define in a list at the top of our script the sounds that make up the initial menu prompt:</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><span class=n>sounds</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;press-1&#39;</span><span class=p>,</span> <span class=s1>&#39;or&#39;</span><span class=p>,</span> <span class=s1>&#39;press-2&#39;</span><span class=p>]</span>
</span></code></pre></div></td></tr></table></div> <p>Since we'll want to maintain some state, we'll create a small object to do that for us. In Python, tuples are immutable - and we'll want to mutate the state in callbacks when certain operations happen. As such, it makes sense to use a small class for this with two properties:</p> <ol type=1> <li>The current sound being played</li> <li>Whether or not we should consider the menu complete</li> </ol> <p>It's useful to have both pieces of data, as we may cancel the menu half-way through and want to take one set of actions, or we may complete the menu and all the sounds and start a different set of actions.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1>1</a></span>
<span class=normal><a href=#__codelineno-2-2>2</a></span>
<span class=normal><a href=#__codelineno-2-3>3</a></span>
<span class=normal><a href=#__codelineno-2-4>4</a></span>
<span class=normal><a href=#__codelineno-2-5>5</a></span>
<span class=normal><a href=#__codelineno-2-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><span class=k>class</span><span class=w> </span><span class=nc>MenuState</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;A small tracking object for the channel in the menu&quot;&quot;&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a> <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>current_sound</span><span class=p>,</span> <span class=n>complete</span><span class=p>):</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5></a> <span class=bp>self</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>=</span> <span class=n>current_sound</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6></a> <span class=bp>self</span><span class=o>.</span><span class=n>complete</span> <span class=o>=</span> <span class=n>complete</span>
</span></code></pre></div></td></tr></table></div> <p>To start, we'll write a function, <code>play_intro_menu</code>, that starts the menu on a channel. It will simply initialize the state of the menu, and get the ball rolling on the channel by calling <code>queue_up_sound</code>.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1> 1</a></span>
<span class=normal><a href=#__codelineno-3-2> 2</a></span>
<span class=normal><a href=#__codelineno-3-3> 3</a></span>
<span class=normal><a href=#__codelineno-3-4> 4</a></span>
<span class=normal><a href=#__codelineno-3-5> 5</a></span>
<span class=normal><a href=#__codelineno-3-6> 6</a></span>
<span class=normal><a href=#__codelineno-3-7> 7</a></span>
<span class=normal><a href=#__codelineno-3-8> 8</a></span>
<span class=normal><a href=#__codelineno-3-9> 9</a></span>
<span class=normal><a href=#__codelineno-3-10>10</a></span>
<span class=normal><a href=#__codelineno-3-11>11</a></span>
<span class=normal><a href=#__codelineno-3-12>12</a></span>
<span class=normal><a href=#__codelineno-3-13>13</a></span>
<span class=normal><a href=#__codelineno-3-14>14</a></span>
<span class=normal><a href=#__codelineno-3-15>15</a></span>
<span class=normal><a href=#__codelineno-3-16>16</a></span>
<span class=normal><a href=#__codelineno-3-17>17</a></span>
<span class=normal><a href=#__codelineno-3-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=k>def</span><span class=w> </span><span class=nf>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Play our intro menu to the specified channel</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3></a><span class=sd> Since we want to interrupt the playback of the menu when the user presses</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4></a><span class=sd> a DTMF key, we maintain the state of the menu via the MenuState object.</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5></a><span class=sd> A menu completes in one of two ways:</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6></a><span class=sd> (1) The user hits a key</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7></a><span class=sd> (2) The menu finishes to completion</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8></a><span class=sd> In the case of (2), a timer is started for the channel. If the timer pops,</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9></a><span class=sd> a prompt is played back and the menu restarted.</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13></a> <span class=n>menu_state</span> <span class=o>=</span> <span class=n>MenuState</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14></a>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15></a> <span class=k>def</span><span class=w> </span><span class=nf>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16></a> <span class=o>...</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17></a>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18></a> <span class=n>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p><code>queue_up_sound</code> will be responsible for starting the next sound file on the channel and handling the manipulation of that sound file. Since there's a fair amount of checking that goes into this, we'll put the actual act of starting the sound in <code>play_next_sound</code>, which will return the <code>Playback</code> object from ARI. We'll prep the <code>menu_state</code> object for the next sound file playback, and pass it to the <code>PlaybackFinished</code> handler for the current sound being played back to the channel.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1> 1</a></span>
<span class=normal><a href=#__codelineno-4-2> 2</a></span>
<span class=normal><a href=#__codelineno-4-3> 3</a></span>
<span class=normal><a href=#__codelineno-4-4> 4</a></span>
<span class=normal><a href=#__codelineno-4-5> 5</a></span>
<span class=normal><a href=#__codelineno-4-6> 6</a></span>
<span class=normal><a href=#__codelineno-4-7> 7</a></span>
<span class=normal><a href=#__codelineno-4-8> 8</a></span>
<span class=normal><a href=#__codelineno-4-9> 9</a></span>
<span class=normal><a href=#__codelineno-4-10>10</a></span>
<span class=normal><a href=#__codelineno-4-11>11</a></span>
<span class=normal><a href=#__codelineno-4-12>12</a></span>
<span class=normal><a href=#__codelineno-4-13>13</a></span>
<span class=normal><a href=#__codelineno-4-14>14</a></span>
<span class=normal><a href=#__codelineno-4-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><span class=k>def</span><span class=w> </span><span class=nf>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Start up the next sound and handle whatever happens</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><span class=sd> Keywords Arguments:</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><span class=sd> menu_state The current state of the menu</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8></a>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=n>play_next_sound</span><span class=p>(</span><span class=n>menu_state</span><span class=p>)</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10></a>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11></a> <span class=k>if</span> <span class=ow>not</span> <span class=n>current_playback</span><span class=p>:</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12></a> <span class=k>return</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;PlaybackFinished&#39;</span><span class=p>,</span> <span class=n>on_playback_finished</span><span class=p>,</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>menu_state</span><span class=p>])</span>
</span></code></pre></div></td></tr></table></div> <p><code>play_next_sound</code> will do two things:</p> <ol type=1> <li>If we shouldn't play another sound - either because we've run out of sounds to play or because the menu is now "complete", we bail and return None.</li> <li>If we should play back a sound, start it up on the channel and return the <code>Playback</code> object.</li> </ol> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1> 1</a></span>
<span class=normal><a href=#__codelineno-5-2> 2</a></span>
<span class=normal><a href=#__codelineno-5-3> 3</a></span>
<span class=normal><a href=#__codelineno-5-4> 4</a></span>
<span class=normal><a href=#__codelineno-5-5> 5</a></span>
<span class=normal><a href=#__codelineno-5-6> 6</a></span>
<span class=normal><a href=#__codelineno-5-7> 7</a></span>
<span class=normal><a href=#__codelineno-5-8> 8</a></span>
<span class=normal><a href=#__codelineno-5-9> 9</a></span>
<span class=normal><a href=#__codelineno-5-10>10</a></span>
<span class=normal><a href=#__codelineno-5-11>11</a></span>
<span class=normal><a href=#__codelineno-5-12>12</a></span>
<span class=normal><a href=#__codelineno-5-13>13</a></span>
<span class=normal><a href=#__codelineno-5-14>14</a></span>
<span class=normal><a href=#__codelineno-5-15>15</a></span>
<span class=normal><a href=#__codelineno-5-16>16</a></span>
<span class=normal><a href=#__codelineno-5-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=k>def</span><span class=w> </span><span class=nf>play_next_sound</span><span class=p>(</span><span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Play the next sound, if we should</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3></a>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5></a><span class=sd> menu_state The current state of the IVR</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7></a><span class=sd> Returns:</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8></a><span class=sd> None if no playback should occur</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9></a><span class=sd> A playback object if a playback was started</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11></a> <span class=k>if</span> <span class=p>(</span><span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>sounds</span><span class=p>)</span> <span class=ow>or</span> <span class=n>menu_state</span><span class=o>.</span><span class=n>complete</span><span class=p>):</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12></a> <span class=k>return</span> <span class=kc>None</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13></a> <span class=k>try</span><span class=p>:</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>sounds</span><span class=p>[</span><span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span><span class=p>])</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15></a> <span class=k>except</span><span class=p>:</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17></a> <span class=k>return</span> <span class=n>current_playback</span>
</span></code></pre></div></td></tr></table></div> <p>Our playback finished handler is very simple: since we've already incremented the state of the menu, we just call <code>queue_up_sound</code> again:</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span>
<span class=normal><a href=#__codelineno-6-2>2</a></span>
<span class=normal><a href=#__codelineno-6-3>3</a></span>
<span class=normal><a href=#__codelineno-6-4>4</a></span>
<span class=normal><a href=#__codelineno-6-5>5</a></span>
<span class=normal><a href=#__codelineno-6-6>6</a></span>
<span class=normal><a href=#__codelineno-6-7>7</a></span>
<span class=normal><a href=#__codelineno-6-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=k>def</span><span class=w> </span><span class=nf>on_playback_finished</span><span class=p>(</span><span class=n>playback</span><span class=p>,</span> <span class=n>ev</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Callback handler for when a playback is finished</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4></a><span class=sd> playback The playback object that finished</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5></a><span class=sd> ev The PlaybackFinished event</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6></a><span class=sd> menu_state The current state of the menu</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8></a> <span class=n>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>To recap, our <code>play_intro_menu</code> function has three nested functions:</p> <ol type=1> <li><code>queue_up_sound</code> - starts a sound on a channel, increments the state of the menu, and subscribes for the <code>PlaybackFinished</code> event.</li> <li><code>play_next_sound</code> - if possible, actually starts the sound. Called from <code>queue_up_sound</code>.</li> <li><code>on_playback_finished</code> - called when <code>PlaybackFinished</code> is received for the current playback, and call <code>queue_up_sound</code> to start the next sound in the menu.</li> </ol> <p>This will play back the menu sounds, but it doesn't handle cancelling the menu, time-outs, or other conditions. To do that, we're going to need more information from Asterisk.</p> <h4 id=cancelling-the-menu>Cancelling the menu<a class=headerlink href=#cancelling-the-menu title="Permanent link">&para;</a></h4> <p>When the user presses a DTMF key, we want to stop the current playback and end the menu. To do that, we'll need to subscribe for DTMF events from the channel. We'll define a new handler function, <code>cancel_menu</code>, and tell <code>ari-py</code> to call it when a DTMF key is received via the <code>ChannelDtmfReceived</code> event. We don't really care about the digit here - we just want to cancel the menu. In the handler function, we'll set <code>menu_state.complete</code> to <code>True</code>, then tell the <code>current_playback</code> to stop.</p> <p>We should also stop the menu when the channel is hung up. Since the <code>cancel_menu</code> , so we'll subscribe to the <code>StasisEnd</code> event here and call <code>cancel_menu</code> from it as well:</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1> 1</a></span>
<span class=normal><a href=#__codelineno-7-2> 2</a></span>
<span class=normal><a href=#__codelineno-7-3> 3</a></span>
<span class=normal><a href=#__codelineno-7-4> 4</a></span>
<span class=normal><a href=#__codelineno-7-5> 5</a></span>
<span class=normal><a href=#__codelineno-7-6> 6</a></span>
<span class=normal><a href=#__codelineno-7-7> 7</a></span>
<span class=normal><a href=#__codelineno-7-8> 8</a></span>
<span class=normal><a href=#__codelineno-7-9> 9</a></span>
<span class=normal><a href=#__codelineno-7-10>10</a></span>
<span class=normal><a href=#__codelineno-7-11>11</a></span>
<span class=normal><a href=#__codelineno-7-12>12</a></span>
<span class=normal><a href=#__codelineno-7-13>13</a></span>
<span class=normal><a href=#__codelineno-7-14>14</a></span>
<span class=normal><a href=#__codelineno-7-15>15</a></span>
<span class=normal><a href=#__codelineno-7-16>16</a></span>
<span class=normal><a href=#__codelineno-7-17>17</a></span>
<span class=normal><a href=#__codelineno-7-18>18</a></span>
<span class=normal><a href=#__codelineno-7-19>19</a></span>
<span class=normal><a href=#__codelineno-7-20>20</a></span>
<span class=normal><a href=#__codelineno-7-21>21</a></span>
<span class=normal><a href=#__codelineno-7-22>22</a></span>
<span class=normal><a href=#__codelineno-7-23>23</a></span>
<span class=normal><a href=#__codelineno-7-24>24</a></span>
<span class=normal><a href=#__codelineno-7-25>25</a></span>
<span class=normal><a href=#__codelineno-7-26>26</a></span>
<span class=normal><a href=#__codelineno-7-27>27</a></span>
<span class=normal><a href=#__codelineno-7-28>28</a></span>
<span class=normal><a href=#__codelineno-7-29>29</a></span>
<span class=normal><a href=#__codelineno-7-30>30</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=k>def</span><span class=w> </span><span class=nf>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Start up the next sound and handle whatever happens</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4></a><span class=sd> Keywords Arguments:</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6></a><span class=sd> menu_state The current state of the menu</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8></a>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=n>play_next_sound</span><span class=p>(</span><span class=n>menu_state</span><span class=p>)</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10></a>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11></a> <span class=k>def</span><span class=w> </span><span class=nf>cancel_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>ev</span><span class=p>,</span> <span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Cancel the menu, as the user did something&quot;&quot;&quot;</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>complete</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14></a> <span class=k>try</span><span class=p>:</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16></a> <span class=k>except</span><span class=p>:</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17></a> <span class=k>pass</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18></a> <span class=k>return</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19></a>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20></a> <span class=k>if</span> <span class=ow>not</span> <span class=n>current_playback</span><span class=p>:</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21></a> <span class=k>return</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;PlaybackFinished&#39;</span><span class=p>,</span> <span class=n>on_playback_finished</span><span class=p>,</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25></a>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26></a> <span class=c1># If the user hits a key or hangs up, cancel the menu operations</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span> <span class=n>cancel_menu</span><span class=p>,</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span> <span class=n>cancel_menu</span><span class=p>,</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>])</span>
</span></code></pre></div></td></tr></table></div> <h4 id=timing-out>Timing out<a class=headerlink href=#timing-out title="Permanent link">&para;</a></h4> <p>Now we can cancel the menu, but we also need to restart it if the user doesn't do anything. We can use a Python timer to start a timer if we're finished playing sounds <em>and</em> we got to the end of the sound prompt list. We don't want to start the timer if the user pressed a DTMF key - in that case, we would have stopped the menu early and we should be off handling their DTMF key press. The timer will call <code>menu_timeout</code>, which will play back a "are you still there?" prompt, then restart the menu.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span>
<span class=normal><a href=#__codelineno-8-12>12</a></span>
<span class=normal><a href=#__codelineno-8-13>13</a></span>
<span class=normal><a href=#__codelineno-8-14>14</a></span>
<span class=normal><a href=#__codelineno-8-15>15</a></span>
<span class=normal><a href=#__codelineno-8-16>16</a></span>
<span class=normal><a href=#__codelineno-8-17>17</a></span>
<span class=normal><a href=#__codelineno-8-18>18</a></span>
<span class=normal><a href=#__codelineno-8-19>19</a></span>
<span class=normal><a href=#__codelineno-8-20>20</a></span>
<span class=normal><a href=#__codelineno-8-21>21</a></span>
<span class=normal><a href=#__codelineno-8-22>22</a></span>
<span class=normal><a href=#__codelineno-8-23>23</a></span>
<span class=normal><a href=#__codelineno-8-24>24</a></span>
<span class=normal><a href=#__codelineno-8-25>25</a></span>
<span class=normal><a href=#__codelineno-8-26>26</a></span>
<span class=normal><a href=#__codelineno-8-27>27</a></span>
<span class=normal><a href=#__codelineno-8-28>28</a></span>
<span class=normal><a href=#__codelineno-8-29>29</a></span>
<span class=normal><a href=#__codelineno-8-30>30</a></span>
<span class=normal><a href=#__codelineno-8-31>31</a></span>
<span class=normal><a href=#__codelineno-8-32>32</a></span>
<span class=normal><a href=#__codelineno-8-33>33</a></span>
<span class=normal><a href=#__codelineno-8-34>34</a></span>
<span class=normal><a href=#__codelineno-8-35>35</a></span>
<span class=normal><a href=#__codelineno-8-36>36</a></span>
<span class=normal><a href=#__codelineno-8-37>37</a></span>
<span class=normal><a href=#__codelineno-8-38>38</a></span>
<span class=normal><a href=#__codelineno-8-39>39</a></span>
<span class=normal><a href=#__codelineno-8-40>40</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=k>def</span><span class=w> </span><span class=nf>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Start up the next sound and handle whatever happens</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><span class=sd> Keywords Arguments:</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a><span class=sd> menu_state The current state of the menu</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a> <span class=k>def</span><span class=w> </span><span class=nf>menu_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Callback called by a timer when the menu times out&quot;&quot;&quot;</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10></a> <span class=nb>print</span> <span class=s1>&#39;Channel </span><span class=si>%s</span><span class=s1> stopped paying attention...&#39;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11></a>  <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:are-you-still-there&#39;</span><span class=p>)</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13></a>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14></a> <span class=k>def</span><span class=w> </span><span class=nf>cancel_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>ev</span><span class=p>,</span> <span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Cancel the menu, as the user did something&quot;&quot;&quot;</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>complete</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17></a> <span class=k>try</span><span class=p>:</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19></a> <span class=k>except</span><span class=p>:</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20></a> <span class=k>pass</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21></a> <span class=k>return</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22></a>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=n>play_next_sound</span><span class=p>(</span><span class=n>menu_state</span><span class=p>)</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24></a> <span class=k>if</span> <span class=ow>not</span> <span class=n>current_playback</span><span class=p>:</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25></a> <span class=k>if</span> <span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>sounds</span><span class=p>):</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26></a> <span class=c1># Menu played, start a timer!</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27></a> <span class=n>timer</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Timer</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>menu_timeout</span><span class=p>,</span> <span class=p>[</span><span class=n>channel</span><span class=p>])</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28></a> <span class=n>channel_timers</span><span class=p>[</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>timer</span>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29></a> <span class=n>timer</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30></a> <span class=k>return</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31></a>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;PlaybackFinished&#39;</span><span class=p>,</span> <span class=n>on_playback_finished</span><span class=p>,</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35></a>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36></a> <span class=c1># If the user hits a key or hangs up, cancel the menu operations</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span> <span class=n>cancel_menu</span><span class=p>,</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span> <span class=n>cancel_menu</span><span class=p>,</span>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>])</span>
</span></code></pre></div></td></tr></table></div> <p>Now that we've introduced timers, we know we're going to need to stop them if the user does something. We'll store the timers in a dictionary indexed by channel ID, so we can get them from various parts of the script:</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=n>channel_timers</span> <span class=o>=</span> <span class=p>{}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=handling-the-dtmf-options>Handling the DTMF options<a class=headerlink href=#handling-the-dtmf-options title="Permanent link">&para;</a></h4> <p>While we now have code that plays back the menu to the user, we actually have to implement the attendant menu still. This is slightly easier than playing the menu. We can register for the <code>ChannelDtmfReceived</code> event in the <code>StasisStart</code> event handler. In that callback, we need to do the following:</p> <ol type=1> <li>Cancel any timers associated with the channel. Note that we don't need to stop the playback of the menu, as the menu function <code>queue_up_sound</code> already registers a handler for that event and cancels the menu when it gets any digit.</li> <li>Actually handle the digit, if the digit is a <code>1</code> or a <code>2</code>.</li> <li>If the digit isn't supported, play a prompt informing the user that their option was invalid, and re-play the menu.</li> </ol> <p>The following implements these three items, deferring processing of the valid options to separate functions.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span>
<span class=normal><a href=#__codelineno-10-22>22</a></span>
<span class=normal><a href=#__codelineno-10-23>23</a></span>
<span class=normal><a href=#__codelineno-10-24>24</a></span>
<span class=normal><a href=#__codelineno-10-25>25</a></span>
<span class=normal><a href=#__codelineno-10-26>26</a></span>
<span class=normal><a href=#__codelineno-10-27>27</a></span>
<span class=normal><a href=#__codelineno-10-28>28</a></span>
<span class=normal><a href=#__codelineno-10-29>29</a></span>
<span class=normal><a href=#__codelineno-10-30>30</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=k>def</span><span class=w> </span><span class=nf>on_dtmf_received</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>ev</span><span class=p>):</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Our main DTMF handler for a channel in the IVR</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6></a><span class=sd> digit The DTMF digit that was pressed</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8></a>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9></a> <span class=c1># Since they pressed something, cancel the timeout timer</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10></a> <span class=n>cancel_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11></a> <span class=n>digit</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ev</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;digit&#39;</span><span class=p>))</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12></a>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13></a> <span class=nb>print</span> <span class=s1>&#39;Channel </span><span class=si>%s</span><span class=s1> entered </span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>),</span> <span class=n>digit</span><span class=p>)</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14></a> <span class=k>if</span> <span class=n>digit</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15></a> <span class=n>handle_extension_one</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16></a> <span class=k>elif</span> <span class=n>digit</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17></a> <span class=n>handle_extension_two</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18></a> <span class=k>else</span><span class=p>:</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19></a> <span class=nb>print</span> <span class=s1>&#39;Channel </span><span class=si>%s</span><span class=s1> entered an invalid option!&#39;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20></a>  <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:option-is-invalid&#39;</span><span class=p>)</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22></a>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23></a><span class=k>def</span><span class=w> </span><span class=nf>stasis_start_cb</span><span class=p>(</span><span class=n>channel_obj</span><span class=p>,</span> <span class=n>ev</span><span class=p>):</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for StasisStart event&quot;&quot;&quot;</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25></a>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26></a> <span class=n>channel</span> <span class=o>=</span> <span class=n>channel_obj</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;channel&#39;</span><span class=p>)</span>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27></a> <span class=nb>print</span> <span class=s2>&quot;Channel </span><span class=si>%s</span><span class=s2> has entered the application&quot;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28></a>
</span><span id=__span-10-29><a id=__codelineno-10-29 name=__codelineno-10-29></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span> <span class=n>on_dtmf_received</span><span class=p>)</span>
</span><span id=__span-10-30><a id=__codelineno-10-30 name=__codelineno-10-30></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>Cancelling the timer is done in a fashion similar to other examples. If the channel has a Python timer associated with it, we cancel the timer and remove it from the dictionary.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1> 1</a></span>
<span class=normal><a href=#__codelineno-11-2> 2</a></span>
<span class=normal><a href=#__codelineno-11-3> 3</a></span>
<span class=normal><a href=#__codelineno-11-4> 4</a></span>
<span class=normal><a href=#__codelineno-11-5> 5</a></span>
<span class=normal><a href=#__codelineno-11-6> 6</a></span>
<span class=normal><a href=#__codelineno-11-7> 7</a></span>
<span class=normal><a href=#__codelineno-11-8> 8</a></span>
<span class=normal><a href=#__codelineno-11-9> 9</a></span>
<span class=normal><a href=#__codelineno-11-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=k>def</span><span class=w> </span><span class=nf>cancel_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Cancel the timeout timer for the channel</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a> <span class=n>timer</span> <span class=o>=</span> <span class=n>channel_timers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a> <span class=k>if</span> <span class=n>timer</span><span class=p>:</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a> <span class=n>timer</span><span class=o>.</span><span class=n>cancel</span><span class=p>()</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a> <span class=k>del</span> <span class=n>channel_timers</span><span class=p>[</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span><span class=p>]</span>
</span></code></pre></div></td></tr></table></div> <p>Finally, we need to actually do <em>something</em> when the user presses a <kbd>1</kbd> or a <kbd>2</kbd>. We could do anything here - but in our case, we're merely going to play back the number that they pressed and restart the menu.</p> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span>
<span class=normal><a href=#__codelineno-12-11>11</a></span>
<span class=normal><a href=#__codelineno-12-12>12</a></span>
<span class=normal><a href=#__codelineno-12-13>13</a></span>
<span class=normal><a href=#__codelineno-12-14>14</a></span>
<span class=normal><a href=#__codelineno-12-15>15</a></span>
<span class=normal><a href=#__codelineno-12-16>16</a></span>
<span class=normal><a href=#__codelineno-12-17>17</a></span>
<span class=normal><a href=#__codelineno-12-18>18</a></span>
<span class=normal><a href=#__codelineno-12-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=k>def</span><span class=w> </span><span class=nf>handle_extension_one</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for a channel pressing &#39;1&#39;</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>)</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;digits:1&#39;</span><span class=p>)</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a><span class=k>def</span><span class=w> </span><span class=nf>handle_extension_two</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for a channel pressing &#39;2&#39;</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>)</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;digits:2&#39;</span><span class=p>)</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <h4 id=channel-aapy>channel-aa.py<a class=headerlink href=#channel-aapy title="Permanent link">&para;</a></h4> <p>The full source for <code>channel-aa.py</code> is shown below:</p> <div class="language-python highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>channel-aa.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>  1</a></span>
<span class=normal><a href=#__codelineno-13-2>  2</a></span>
<span class=normal><a href=#__codelineno-13-3>  3</a></span>
<span class=normal><a href=#__codelineno-13-4>  4</a></span>
<span class=normal><a href=#__codelineno-13-5>  5</a></span>
<span class=normal><a href=#__codelineno-13-6>  6</a></span>
<span class=normal><a href=#__codelineno-13-7>  7</a></span>
<span class=normal><a href=#__codelineno-13-8>  8</a></span>
<span class=normal><a href=#__codelineno-13-9>  9</a></span>
<span class=normal><a href=#__codelineno-13-10> 10</a></span>
<span class=normal><a href=#__codelineno-13-11> 11</a></span>
<span class=normal><a href=#__codelineno-13-12> 12</a></span>
<span class=normal><a href=#__codelineno-13-13> 13</a></span>
<span class=normal><a href=#__codelineno-13-14> 14</a></span>
<span class=normal><a href=#__codelineno-13-15> 15</a></span>
<span class=normal><a href=#__codelineno-13-16> 16</a></span>
<span class=normal><a href=#__codelineno-13-17> 17</a></span>
<span class=normal><a href=#__codelineno-13-18> 18</a></span>
<span class=normal><a href=#__codelineno-13-19> 19</a></span>
<span class=normal><a href=#__codelineno-13-20> 20</a></span>
<span class=normal><a href=#__codelineno-13-21> 21</a></span>
<span class=normal><a href=#__codelineno-13-22> 22</a></span>
<span class=normal><a href=#__codelineno-13-23> 23</a></span>
<span class=normal><a href=#__codelineno-13-24> 24</a></span>
<span class=normal><a href=#__codelineno-13-25> 25</a></span>
<span class=normal><a href=#__codelineno-13-26> 26</a></span>
<span class=normal><a href=#__codelineno-13-27> 27</a></span>
<span class=normal><a href=#__codelineno-13-28> 28</a></span>
<span class=normal><a href=#__codelineno-13-29> 29</a></span>
<span class=normal><a href=#__codelineno-13-30> 30</a></span>
<span class=normal><a href=#__codelineno-13-31> 31</a></span>
<span class=normal><a href=#__codelineno-13-32> 32</a></span>
<span class=normal><a href=#__codelineno-13-33> 33</a></span>
<span class=normal><a href=#__codelineno-13-34> 34</a></span>
<span class=normal><a href=#__codelineno-13-35> 35</a></span>
<span class=normal><a href=#__codelineno-13-36> 36</a></span>
<span class=normal><a href=#__codelineno-13-37> 37</a></span>
<span class=normal><a href=#__codelineno-13-38> 38</a></span>
<span class=normal><a href=#__codelineno-13-39> 39</a></span>
<span class=normal><a href=#__codelineno-13-40> 40</a></span>
<span class=normal><a href=#__codelineno-13-41> 41</a></span>
<span class=normal><a href=#__codelineno-13-42> 42</a></span>
<span class=normal><a href=#__codelineno-13-43> 43</a></span>
<span class=normal><a href=#__codelineno-13-44> 44</a></span>
<span class=normal><a href=#__codelineno-13-45> 45</a></span>
<span class=normal><a href=#__codelineno-13-46> 46</a></span>
<span class=normal><a href=#__codelineno-13-47> 47</a></span>
<span class=normal><a href=#__codelineno-13-48> 48</a></span>
<span class=normal><a href=#__codelineno-13-49> 49</a></span>
<span class=normal><a href=#__codelineno-13-50> 50</a></span>
<span class=normal><a href=#__codelineno-13-51> 51</a></span>
<span class=normal><a href=#__codelineno-13-52> 52</a></span>
<span class=normal><a href=#__codelineno-13-53> 53</a></span>
<span class=normal><a href=#__codelineno-13-54> 54</a></span>
<span class=normal><a href=#__codelineno-13-55> 55</a></span>
<span class=normal><a href=#__codelineno-13-56> 56</a></span>
<span class=normal><a href=#__codelineno-13-57> 57</a></span>
<span class=normal><a href=#__codelineno-13-58> 58</a></span>
<span class=normal><a href=#__codelineno-13-59> 59</a></span>
<span class=normal><a href=#__codelineno-13-60> 60</a></span>
<span class=normal><a href=#__codelineno-13-61> 61</a></span>
<span class=normal><a href=#__codelineno-13-62> 62</a></span>
<span class=normal><a href=#__codelineno-13-63> 63</a></span>
<span class=normal><a href=#__codelineno-13-64> 64</a></span>
<span class=normal><a href=#__codelineno-13-65> 65</a></span>
<span class=normal><a href=#__codelineno-13-66> 66</a></span>
<span class=normal><a href=#__codelineno-13-67> 67</a></span>
<span class=normal><a href=#__codelineno-13-68> 68</a></span>
<span class=normal><a href=#__codelineno-13-69> 69</a></span>
<span class=normal><a href=#__codelineno-13-70> 70</a></span>
<span class=normal><a href=#__codelineno-13-71> 71</a></span>
<span class=normal><a href=#__codelineno-13-72> 72</a></span>
<span class=normal><a href=#__codelineno-13-73> 73</a></span>
<span class=normal><a href=#__codelineno-13-74> 74</a></span>
<span class=normal><a href=#__codelineno-13-75> 75</a></span>
<span class=normal><a href=#__codelineno-13-76> 76</a></span>
<span class=normal><a href=#__codelineno-13-77> 77</a></span>
<span class=normal><a href=#__codelineno-13-78> 78</a></span>
<span class=normal><a href=#__codelineno-13-79> 79</a></span>
<span class=normal><a href=#__codelineno-13-80> 80</a></span>
<span class=normal><a href=#__codelineno-13-81> 81</a></span>
<span class=normal><a href=#__codelineno-13-82> 82</a></span>
<span class=normal><a href=#__codelineno-13-83> 83</a></span>
<span class=normal><a href=#__codelineno-13-84> 84</a></span>
<span class=normal><a href=#__codelineno-13-85> 85</a></span>
<span class=normal><a href=#__codelineno-13-86> 86</a></span>
<span class=normal><a href=#__codelineno-13-87> 87</a></span>
<span class=normal><a href=#__codelineno-13-88> 88</a></span>
<span class=normal><a href=#__codelineno-13-89> 89</a></span>
<span class=normal><a href=#__codelineno-13-90> 90</a></span>
<span class=normal><a href=#__codelineno-13-91> 91</a></span>
<span class=normal><a href=#__codelineno-13-92> 92</a></span>
<span class=normal><a href=#__codelineno-13-93> 93</a></span>
<span class=normal><a href=#__codelineno-13-94> 94</a></span>
<span class=normal><a href=#__codelineno-13-95> 95</a></span>
<span class=normal><a href=#__codelineno-13-96> 96</a></span>
<span class=normal><a href=#__codelineno-13-97> 97</a></span>
<span class=normal><a href=#__codelineno-13-98> 98</a></span>
<span class=normal><a href=#__codelineno-13-99> 99</a></span>
<span class=normal><a href=#__codelineno-13-100>100</a></span>
<span class=normal><a href=#__codelineno-13-101>101</a></span>
<span class=normal><a href=#__codelineno-13-102>102</a></span>
<span class=normal><a href=#__codelineno-13-103>103</a></span>
<span class=normal><a href=#__codelineno-13-104>104</a></span>
<span class=normal><a href=#__codelineno-13-105>105</a></span>
<span class=normal><a href=#__codelineno-13-106>106</a></span>
<span class=normal><a href=#__codelineno-13-107>107</a></span>
<span class=normal><a href=#__codelineno-13-108>108</a></span>
<span class=normal><a href=#__codelineno-13-109>109</a></span>
<span class=normal><a href=#__codelineno-13-110>110</a></span>
<span class=normal><a href=#__codelineno-13-111>111</a></span>
<span class=normal><a href=#__codelineno-13-112>112</a></span>
<span class=normal><a href=#__codelineno-13-113>113</a></span>
<span class=normal><a href=#__codelineno-13-114>114</a></span>
<span class=normal><a href=#__codelineno-13-115>115</a></span>
<span class=normal><a href=#__codelineno-13-116>116</a></span>
<span class=normal><a href=#__codelineno-13-117>117</a></span>
<span class=normal><a href=#__codelineno-13-118>118</a></span>
<span class=normal><a href=#__codelineno-13-119>119</a></span>
<span class=normal><a href=#__codelineno-13-120>120</a></span>
<span class=normal><a href=#__codelineno-13-121>121</a></span>
<span class=normal><a href=#__codelineno-13-122>122</a></span>
<span class=normal><a href=#__codelineno-13-123>123</a></span>
<span class=normal><a href=#__codelineno-13-124>124</a></span>
<span class=normal><a href=#__codelineno-13-125>125</a></span>
<span class=normal><a href=#__codelineno-13-126>126</a></span>
<span class=normal><a href=#__codelineno-13-127>127</a></span>
<span class=normal><a href=#__codelineno-13-128>128</a></span>
<span class=normal><a href=#__codelineno-13-129>129</a></span>
<span class=normal><a href=#__codelineno-13-130>130</a></span>
<span class=normal><a href=#__codelineno-13-131>131</a></span>
<span class=normal><a href=#__codelineno-13-132>132</a></span>
<span class=normal><a href=#__codelineno-13-133>133</a></span>
<span class=normal><a href=#__codelineno-13-134>134</a></span>
<span class=normal><a href=#__codelineno-13-135>135</a></span>
<span class=normal><a href=#__codelineno-13-136>136</a></span>
<span class=normal><a href=#__codelineno-13-137>137</a></span>
<span class=normal><a href=#__codelineno-13-138>138</a></span>
<span class=normal><a href=#__codelineno-13-139>139</a></span>
<span class=normal><a href=#__codelineno-13-140>140</a></span>
<span class=normal><a href=#__codelineno-13-141>141</a></span>
<span class=normal><a href=#__codelineno-13-142>142</a></span>
<span class=normal><a href=#__codelineno-13-143>143</a></span>
<span class=normal><a href=#__codelineno-13-144>144</a></span>
<span class=normal><a href=#__codelineno-13-145>145</a></span>
<span class=normal><a href=#__codelineno-13-146>146</a></span>
<span class=normal><a href=#__codelineno-13-147>147</a></span>
<span class=normal><a href=#__codelineno-13-148>148</a></span>
<span class=normal><a href=#__codelineno-13-149>149</a></span>
<span class=normal><a href=#__codelineno-13-150>150</a></span>
<span class=normal><a href=#__codelineno-13-151>151</a></span>
<span class=normal><a href=#__codelineno-13-152>152</a></span>
<span class=normal><a href=#__codelineno-13-153>153</a></span>
<span class=normal><a href=#__codelineno-13-154>154</a></span>
<span class=normal><a href=#__codelineno-13-155>155</a></span>
<span class=normal><a href=#__codelineno-13-156>156</a></span>
<span class=normal><a href=#__codelineno-13-157>157</a></span>
<span class=normal><a href=#__codelineno-13-158>158</a></span>
<span class=normal><a href=#__codelineno-13-159>159</a></span>
<span class=normal><a href=#__codelineno-13-160>160</a></span>
<span class=normal><a href=#__codelineno-13-161>161</a></span>
<span class=normal><a href=#__codelineno-13-162>162</a></span>
<span class=normal><a href=#__codelineno-13-163>163</a></span>
<span class=normal><a href=#__codelineno-13-164>164</a></span>
<span class=normal><a href=#__codelineno-13-165>165</a></span>
<span class=normal><a href=#__codelineno-13-166>166</a></span>
<span class=normal><a href=#__codelineno-13-167>167</a></span>
<span class=normal><a href=#__codelineno-13-168>168</a></span>
<span class=normal><a href=#__codelineno-13-169>169</a></span>
<span class=normal><a href=#__codelineno-13-170>170</a></span>
<span class=normal><a href=#__codelineno-13-171>171</a></span>
<span class=normal><a href=#__codelineno-13-172>172</a></span>
<span class=normal><a href=#__codelineno-13-173>173</a></span>
<span class=normal><a href=#__codelineno-13-174>174</a></span>
<span class=normal><a href=#__codelineno-13-175>175</a></span>
<span class=normal><a href=#__codelineno-13-176>176</a></span>
<span class=normal><a href=#__codelineno-13-177>177</a></span>
<span class=normal><a href=#__codelineno-13-178>178</a></span>
<span class=normal><a href=#__codelineno-13-179>179</a></span>
<span class=normal><a href=#__codelineno-13-180>180</a></span>
<span class=normal><a href=#__codelineno-13-181>181</a></span>
<span class=normal><a href=#__codelineno-13-182>182</a></span>
<span class=normal><a href=#__codelineno-13-183>183</a></span>
<span class=normal><a href=#__codelineno-13-184>184</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=ch>#!/usr/bin/env python</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a><span class=kn>import</span><span class=w> </span><span class=nn>ari</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>ERROR</span><span class=p>)</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><span class=n>client</span> <span class=o>=</span> <span class=n>ari</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;http://localhost:8088&#39;</span><span class=p>,</span> <span class=s1>&#39;asterisk&#39;</span><span class=p>,</span> <span class=s1>&#39;asterisk&#39;</span><span class=p>)</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10></a>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11></a><span class=c1># Note: this uses the &#39;extra&#39; sounds package</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12></a><span class=n>sounds</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;press-1&#39;</span><span class=p>,</span> <span class=s1>&#39;or&#39;</span><span class=p>,</span> <span class=s1>&#39;press-2&#39;</span><span class=p>]</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13></a>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14></a><span class=n>channel_timers</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15></a>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16></a><span class=k>class</span><span class=w> </span><span class=nc>MenuState</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17></a><span class=w> </span><span class=sd>&quot;&quot;&quot;A small tracking object for the channel in the menu&quot;&quot;&quot;</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18></a>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19></a> <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>current_sound</span><span class=p>,</span> <span class=n>complete</span><span class=p>):</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20></a> <span class=bp>self</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>=</span> <span class=n>current_sound</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21></a> <span class=bp>self</span><span class=o>.</span><span class=n>complete</span> <span class=o>=</span> <span class=n>complete</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22></a>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23></a><span class=k>def</span><span class=w> </span><span class=nf>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Play our intro menu to the specified channel</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25></a>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26></a><span class=sd> Since we want to interrupt the playback of the menu when the user presses</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27></a><span class=sd> a DTMF key, we maintain the state of the menu via the MenuState object.</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28></a><span class=sd> A menu completes in one of two ways:</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29></a><span class=sd> (1) The user hits a key</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30></a><span class=sd> (2) The menu finishes to completion</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31></a>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32></a><span class=sd> In the case of (2), a timer is started for the channel. If the timer pops,</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33></a><span class=sd> a prompt is played back and the menu restarted.</span>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34></a>
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38></a>
</span><span id=__span-13-39><a id=__codelineno-13-39 name=__codelineno-13-39></a> <span class=n>menu_state</span> <span class=o>=</span> <span class=n>MenuState</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span><span id=__span-13-40><a id=__codelineno-13-40 name=__codelineno-13-40></a>
</span><span id=__span-13-41><a id=__codelineno-13-41 name=__codelineno-13-41></a> <span class=k>def</span><span class=w> </span><span class=nf>play_next_sound</span><span class=p>(</span><span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-13-42><a id=__codelineno-13-42 name=__codelineno-13-42></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Play the next sound, if we should</span>
</span><span id=__span-13-43><a id=__codelineno-13-43 name=__codelineno-13-43></a>
</span><span id=__span-13-44><a id=__codelineno-13-44 name=__codelineno-13-44></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-45><a id=__codelineno-13-45 name=__codelineno-13-45></a><span class=sd> menu_state The current state of the IVR</span>
</span><span id=__span-13-46><a id=__codelineno-13-46 name=__codelineno-13-46></a>
</span><span id=__span-13-47><a id=__codelineno-13-47 name=__codelineno-13-47></a><span class=sd> Returns:</span>
</span><span id=__span-13-48><a id=__codelineno-13-48 name=__codelineno-13-48></a><span class=sd> None if no playback should occur</span>
</span><span id=__span-13-49><a id=__codelineno-13-49 name=__codelineno-13-49></a><span class=sd> A playback object if a playback was started</span>
</span><span id=__span-13-50><a id=__codelineno-13-50 name=__codelineno-13-50></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-51><a id=__codelineno-13-51 name=__codelineno-13-51></a> <span class=k>if</span> <span class=p>(</span><span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>sounds</span><span class=p>)</span> <span class=ow>or</span> <span class=n>menu_state</span><span class=o>.</span><span class=n>complete</span><span class=p>):</span>
</span><span id=__span-13-52><a id=__codelineno-13-52 name=__codelineno-13-52></a> <span class=k>return</span> <span class=kc>None</span>
</span><span id=__span-13-53><a id=__codelineno-13-53 name=__codelineno-13-53></a> <span class=k>try</span><span class=p>:</span>
</span><span id=__span-13-54><a id=__codelineno-13-54 name=__codelineno-13-54></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>sounds</span><span class=p>[</span><span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span><span class=p>])</span>
</span><span id=__span-13-55><a id=__codelineno-13-55 name=__codelineno-13-55></a> <span class=k>except</span><span class=p>:</span>
</span><span id=__span-13-56><a id=__codelineno-13-56 name=__codelineno-13-56></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-13-57><a id=__codelineno-13-57 name=__codelineno-13-57></a> <span class=k>return</span> <span class=n>current_playback</span>
</span><span id=__span-13-58><a id=__codelineno-13-58 name=__codelineno-13-58></a>
</span><span id=__span-13-59><a id=__codelineno-13-59 name=__codelineno-13-59></a> <span class=k>def</span><span class=w> </span><span class=nf>on_playback_finished</span><span class=p>(</span><span class=n>playback</span><span class=p>,</span> <span class=n>ev</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-13-60><a id=__codelineno-13-60 name=__codelineno-13-60></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Callback handler for when a playback is finished</span>
</span><span id=__span-13-61><a id=__codelineno-13-61 name=__codelineno-13-61></a>
</span><span id=__span-13-62><a id=__codelineno-13-62 name=__codelineno-13-62></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-63><a id=__codelineno-13-63 name=__codelineno-13-63></a><span class=sd> playback The playback object that finished</span>
</span><span id=__span-13-64><a id=__codelineno-13-64 name=__codelineno-13-64></a><span class=sd> ev The PlaybackFinished event</span>
</span><span id=__span-13-65><a id=__codelineno-13-65 name=__codelineno-13-65></a><span class=sd> menu_state The current state of the menu</span>
</span><span id=__span-13-66><a id=__codelineno-13-66 name=__codelineno-13-66></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-67><a id=__codelineno-13-67 name=__codelineno-13-67></a> <span class=n>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>)</span>
</span><span id=__span-13-68><a id=__codelineno-13-68 name=__codelineno-13-68></a>
</span><span id=__span-13-69><a id=__codelineno-13-69 name=__codelineno-13-69></a> <span class=k>def</span><span class=w> </span><span class=nf>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-13-70><a id=__codelineno-13-70 name=__codelineno-13-70></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Start up the next sound and handle whatever happens</span>
</span><span id=__span-13-71><a id=__codelineno-13-71 name=__codelineno-13-71></a>
</span><span id=__span-13-72><a id=__codelineno-13-72 name=__codelineno-13-72></a><span class=sd> Keywords Arguments:</span>
</span><span id=__span-13-73><a id=__codelineno-13-73 name=__codelineno-13-73></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-13-74><a id=__codelineno-13-74 name=__codelineno-13-74></a><span class=sd> menu_state The current state of the menu</span>
</span><span id=__span-13-75><a id=__codelineno-13-75 name=__codelineno-13-75></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-76><a id=__codelineno-13-76 name=__codelineno-13-76></a>
</span><span id=__span-13-77><a id=__codelineno-13-77 name=__codelineno-13-77></a> <span class=k>def</span><span class=w> </span><span class=nf>menu_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-13-78><a id=__codelineno-13-78 name=__codelineno-13-78></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Callback called by a timer when the menu times out&quot;&quot;&quot;</span>
</span><span id=__span-13-79><a id=__codelineno-13-79 name=__codelineno-13-79></a> <span class=nb>print</span> <span class=s1>&#39;Channel </span><span class=si>%s</span><span class=s1> stopped paying attention...&#39;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-13-80><a id=__codelineno-13-80 name=__codelineno-13-80></a>  <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:are-you-still-there&#39;</span><span class=p>)</span>
</span><span id=__span-13-81><a id=__codelineno-13-81 name=__codelineno-13-81></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-82><a id=__codelineno-13-82 name=__codelineno-13-82></a>
</span><span id=__span-13-83><a id=__codelineno-13-83 name=__codelineno-13-83></a> <span class=k>def</span><span class=w> </span><span class=nf>cancel_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>ev</span><span class=p>,</span> <span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>):</span>
</span><span id=__span-13-84><a id=__codelineno-13-84 name=__codelineno-13-84></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Cancel the menu, as the user did something&quot;&quot;&quot;</span>
</span><span id=__span-13-85><a id=__codelineno-13-85 name=__codelineno-13-85></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>complete</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-13-86><a id=__codelineno-13-86 name=__codelineno-13-86></a> <span class=k>try</span><span class=p>:</span>
</span><span id=__span-13-87><a id=__codelineno-13-87 name=__codelineno-13-87></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-13-88><a id=__codelineno-13-88 name=__codelineno-13-88></a> <span class=k>except</span><span class=p>:</span>
</span><span id=__span-13-89><a id=__codelineno-13-89 name=__codelineno-13-89></a> <span class=k>pass</span>
</span><span id=__span-13-90><a id=__codelineno-13-90 name=__codelineno-13-90></a> <span class=k>return</span>
</span><span id=__span-13-91><a id=__codelineno-13-91 name=__codelineno-13-91></a>
</span><span id=__span-13-92><a id=__codelineno-13-92 name=__codelineno-13-92></a> <span class=n>current_playback</span> <span class=o>=</span> <span class=n>play_next_sound</span><span class=p>(</span><span class=n>menu_state</span><span class=p>)</span>
</span><span id=__span-13-93><a id=__codelineno-13-93 name=__codelineno-13-93></a> <span class=k>if</span> <span class=ow>not</span> <span class=n>current_playback</span><span class=p>:</span>
</span><span id=__span-13-94><a id=__codelineno-13-94 name=__codelineno-13-94></a> <span class=k>if</span> <span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>sounds</span><span class=p>):</span>
</span><span id=__span-13-95><a id=__codelineno-13-95 name=__codelineno-13-95></a> <span class=c1># Menu played, start a timer!</span>
</span><span id=__span-13-96><a id=__codelineno-13-96 name=__codelineno-13-96></a> <span class=n>timer</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Timer</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>menu_timeout</span><span class=p>,</span> <span class=p>[</span><span class=n>channel</span><span class=p>])</span>
</span><span id=__span-13-97><a id=__codelineno-13-97 name=__codelineno-13-97></a> <span class=n>channel_timers</span><span class=p>[</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>timer</span>
</span><span id=__span-13-98><a id=__codelineno-13-98 name=__codelineno-13-98></a> <span class=n>timer</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-13-99><a id=__codelineno-13-99 name=__codelineno-13-99></a> <span class=k>return</span>
</span><span id=__span-13-100><a id=__codelineno-13-100 name=__codelineno-13-100></a>
</span><span id=__span-13-101><a id=__codelineno-13-101 name=__codelineno-13-101></a> <span class=n>menu_state</span><span class=o>.</span><span class=n>current_sound</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-13-102><a id=__codelineno-13-102 name=__codelineno-13-102></a> <span class=n>current_playback</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;PlaybackFinished&#39;</span><span class=p>,</span> <span class=n>on_playback_finished</span><span class=p>,</span>
</span><span id=__span-13-103><a id=__codelineno-13-103 name=__codelineno-13-103></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-13-104><a id=__codelineno-13-104 name=__codelineno-13-104></a>
</span><span id=__span-13-105><a id=__codelineno-13-105 name=__codelineno-13-105></a> <span class=c1># If the user hits a key or hangs up, cancel the menu operations</span>
</span><span id=__span-13-106><a id=__codelineno-13-106 name=__codelineno-13-106></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span> <span class=n>cancel_menu</span><span class=p>,</span>
</span><span id=__span-13-107><a id=__codelineno-13-107 name=__codelineno-13-107></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-13-108><a id=__codelineno-13-108 name=__codelineno-13-108></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span> <span class=n>cancel_menu</span><span class=p>,</span>
</span><span id=__span-13-109><a id=__codelineno-13-109 name=__codelineno-13-109></a> <span class=n>callback_args</span><span class=o>=</span><span class=p>[</span><span class=n>current_playback</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>])</span>
</span><span id=__span-13-110><a id=__codelineno-13-110 name=__codelineno-13-110></a>
</span><span id=__span-13-111><a id=__codelineno-13-111 name=__codelineno-13-111></a> <span class=n>queue_up_sound</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>menu_state</span><span class=p>)</span>
</span><span id=__span-13-112><a id=__codelineno-13-112 name=__codelineno-13-112></a>
</span><span id=__span-13-113><a id=__codelineno-13-113 name=__codelineno-13-113></a><span class=k>def</span><span class=w> </span><span class=nf>handle_extension_one</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-13-114><a id=__codelineno-13-114 name=__codelineno-13-114></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for a channel pressing &#39;1&#39;</span>
</span><span id=__span-13-115><a id=__codelineno-13-115 name=__codelineno-13-115></a>
</span><span id=__span-13-116><a id=__codelineno-13-116 name=__codelineno-13-116></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-117><a id=__codelineno-13-117 name=__codelineno-13-117></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-13-118><a id=__codelineno-13-118 name=__codelineno-13-118></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-119><a id=__codelineno-13-119 name=__codelineno-13-119></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>)</span>
</span><span id=__span-13-120><a id=__codelineno-13-120 name=__codelineno-13-120></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;digits:1&#39;</span><span class=p>)</span>
</span><span id=__span-13-121><a id=__codelineno-13-121 name=__codelineno-13-121></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-122><a id=__codelineno-13-122 name=__codelineno-13-122></a>
</span><span id=__span-13-123><a id=__codelineno-13-123 name=__codelineno-13-123></a><span class=k>def</span><span class=w> </span><span class=nf>handle_extension_two</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-13-124><a id=__codelineno-13-124 name=__codelineno-13-124></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for a channel pressing &#39;2&#39;</span>
</span><span id=__span-13-125><a id=__codelineno-13-125 name=__codelineno-13-125></a>
</span><span id=__span-13-126><a id=__codelineno-13-126 name=__codelineno-13-126></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-127><a id=__codelineno-13-127 name=__codelineno-13-127></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-13-128><a id=__codelineno-13-128 name=__codelineno-13-128></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-129><a id=__codelineno-13-129 name=__codelineno-13-129></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>)</span>
</span><span id=__span-13-130><a id=__codelineno-13-130 name=__codelineno-13-130></a> <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;digits:2&#39;</span><span class=p>)</span>
</span><span id=__span-13-131><a id=__codelineno-13-131 name=__codelineno-13-131></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-132><a id=__codelineno-13-132 name=__codelineno-13-132></a>
</span><span id=__span-13-133><a id=__codelineno-13-133 name=__codelineno-13-133></a><span class=k>def</span><span class=w> </span><span class=nf>cancel_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>):</span>
</span><span id=__span-13-134><a id=__codelineno-13-134 name=__codelineno-13-134></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Cancel the timeout timer for the channel</span>
</span><span id=__span-13-135><a id=__codelineno-13-135 name=__codelineno-13-135></a>
</span><span id=__span-13-136><a id=__codelineno-13-136 name=__codelineno-13-136></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-137><a id=__codelineno-13-137 name=__codelineno-13-137></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-13-138><a id=__codelineno-13-138 name=__codelineno-13-138></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-139><a id=__codelineno-13-139 name=__codelineno-13-139></a> <span class=n>timer</span> <span class=o>=</span> <span class=n>channel_timers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-13-140><a id=__codelineno-13-140 name=__codelineno-13-140></a> <span class=k>if</span> <span class=n>timer</span><span class=p>:</span>
</span><span id=__span-13-141><a id=__codelineno-13-141 name=__codelineno-13-141></a> <span class=n>timer</span><span class=o>.</span><span class=n>cancel</span><span class=p>()</span>
</span><span id=__span-13-142><a id=__codelineno-13-142 name=__codelineno-13-142></a> <span class=k>del</span> <span class=n>channel_timers</span><span class=p>[</span><span class=n>channel</span><span class=o>.</span><span class=n>id</span><span class=p>]</span>
</span><span id=__span-13-143><a id=__codelineno-13-143 name=__codelineno-13-143></a>
</span><span id=__span-13-144><a id=__codelineno-13-144 name=__codelineno-13-144></a><span class=k>def</span><span class=w> </span><span class=nf>on_dtmf_received</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>ev</span><span class=p>):</span>
</span><span id=__span-13-145><a id=__codelineno-13-145 name=__codelineno-13-145></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Our main DTMF handler for a channel in the IVR</span>
</span><span id=__span-13-146><a id=__codelineno-13-146 name=__codelineno-13-146></a>
</span><span id=__span-13-147><a id=__codelineno-13-147 name=__codelineno-13-147></a><span class=sd> Keyword Arguments:</span>
</span><span id=__span-13-148><a id=__codelineno-13-148 name=__codelineno-13-148></a><span class=sd> channel The channel in the IVR</span>
</span><span id=__span-13-149><a id=__codelineno-13-149 name=__codelineno-13-149></a><span class=sd> digit The DTMF digit that was pressed</span>
</span><span id=__span-13-150><a id=__codelineno-13-150 name=__codelineno-13-150></a><span class=sd> &quot;&quot;&quot;</span>
</span><span id=__span-13-151><a id=__codelineno-13-151 name=__codelineno-13-151></a>
</span><span id=__span-13-152><a id=__codelineno-13-152 name=__codelineno-13-152></a> <span class=c1># Since they pressed something, cancel the timeout timer</span>
</span><span id=__span-13-153><a id=__codelineno-13-153 name=__codelineno-13-153></a> <span class=n>cancel_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-154><a id=__codelineno-13-154 name=__codelineno-13-154></a> <span class=n>digit</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ev</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;digit&#39;</span><span class=p>))</span>
</span><span id=__span-13-155><a id=__codelineno-13-155 name=__codelineno-13-155></a>
</span><span id=__span-13-156><a id=__codelineno-13-156 name=__codelineno-13-156></a> <span class=nb>print</span> <span class=s1>&#39;Channel </span><span class=si>%s</span><span class=s1> entered </span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>),</span> <span class=n>digit</span><span class=p>)</span>
</span><span id=__span-13-157><a id=__codelineno-13-157 name=__codelineno-13-157></a> <span class=k>if</span> <span class=n>digit</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-13-158><a id=__codelineno-13-158 name=__codelineno-13-158></a> <span class=n>handle_extension_one</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-159><a id=__codelineno-13-159 name=__codelineno-13-159></a> <span class=k>elif</span> <span class=n>digit</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span><span id=__span-13-160><a id=__codelineno-13-160 name=__codelineno-13-160></a> <span class=n>handle_extension_two</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-161><a id=__codelineno-13-161 name=__codelineno-13-161></a> <span class=k>else</span><span class=p>:</span>
</span><span id=__span-13-162><a id=__codelineno-13-162 name=__codelineno-13-162></a> <span class=nb>print</span> <span class=s1>&#39;Channel </span><span class=si>%s</span><span class=s1> entered an invalid option!&#39;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-13-163><a id=__codelineno-13-163 name=__codelineno-13-163></a>  <span class=n>channel</span><span class=o>.</span><span class=n>play</span><span class=p>(</span><span class=n>media</span><span class=o>=</span><span class=s1>&#39;sound:option-is-invalid&#39;</span><span class=p>)</span>
</span><span id=__span-13-164><a id=__codelineno-13-164 name=__codelineno-13-164></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-165><a id=__codelineno-13-165 name=__codelineno-13-165></a>
</span><span id=__span-13-166><a id=__codelineno-13-166 name=__codelineno-13-166></a><span class=k>def</span><span class=w> </span><span class=nf>stasis_start_cb</span><span class=p>(</span><span class=n>channel_obj</span><span class=p>,</span> <span class=n>ev</span><span class=p>):</span>
</span><span id=__span-13-167><a id=__codelineno-13-167 name=__codelineno-13-167></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for StasisStart event&quot;&quot;&quot;</span>
</span><span id=__span-13-168><a id=__codelineno-13-168 name=__codelineno-13-168></a>
</span><span id=__span-13-169><a id=__codelineno-13-169 name=__codelineno-13-169></a> <span class=n>channel</span> <span class=o>=</span> <span class=n>channel_obj</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;channel&#39;</span><span class=p>)</span>
</span><span id=__span-13-170><a id=__codelineno-13-170 name=__codelineno-13-170></a> <span class=nb>print</span> <span class=s2>&quot;Channel </span><span class=si>%s</span><span class=s2> has entered the application&quot;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-13-171><a id=__codelineno-13-171 name=__codelineno-13-171></a>
</span><span id=__span-13-172><a id=__codelineno-13-172 name=__codelineno-13-172></a> <span class=n>channel</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span> <span class=n>on_dtmf_received</span><span class=p>)</span>
</span><span id=__span-13-173><a id=__codelineno-13-173 name=__codelineno-13-173></a> <span class=n>play_intro_menu</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-174><a id=__codelineno-13-174 name=__codelineno-13-174></a>
</span><span id=__span-13-175><a id=__codelineno-13-175 name=__codelineno-13-175></a><span class=k>def</span><span class=w> </span><span class=nf>stasis_end_cb</span><span class=p>(</span><span class=n>channel</span><span class=p>,</span> <span class=n>ev</span><span class=p>):</span>
</span><span id=__span-13-176><a id=__codelineno-13-176 name=__codelineno-13-176></a><span class=w> </span><span class=sd>&quot;&quot;&quot;Handler for StasisEnd event&quot;&quot;&quot;</span>
</span><span id=__span-13-177><a id=__codelineno-13-177 name=__codelineno-13-177></a>
</span><span id=__span-13-178><a id=__codelineno-13-178 name=__codelineno-13-178></a> <span class=nb>print</span> <span class=s2>&quot;</span><span class=si>%s</span><span class=s2> has left the application&quot;</span> <span class=o>%</span> <span class=n>channel</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
</span><span id=__span-13-179><a id=__codelineno-13-179 name=__codelineno-13-179></a> <span class=n>cancel_timeout</span><span class=p>(</span><span class=n>channel</span><span class=p>)</span>
</span><span id=__span-13-180><a id=__codelineno-13-180 name=__codelineno-13-180></a>
</span><span id=__span-13-181><a id=__codelineno-13-181 name=__codelineno-13-181></a><span class=n>client</span><span class=o>.</span><span class=n>on_channel_event</span><span class=p>(</span><span class=s1>&#39;StasisStart&#39;</span><span class=p>,</span> <span class=n>stasis_start_cb</span><span class=p>)</span>
</span><span id=__span-13-182><a id=__codelineno-13-182 name=__codelineno-13-182></a><span class=n>client</span><span class=o>.</span><span class=n>on_channel_event</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span> <span class=n>stasis_end_cb</span><span class=p>)</span>
</span><span id=__span-13-183><a id=__codelineno-13-183 name=__codelineno-13-183></a>
</span><span id=__span-13-184><a id=__codelineno-13-184 name=__codelineno-13-184></a><span class=n>client</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>apps</span><span class=o>=</span><span class=s1>&#39;channel-aa&#39;</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <h4 id=channel-aapy-in-action>channel-aa.py in action<a class=headerlink href=#channel-aapy-in-action title="Permanent link">&para;</a></h4> <p>The following shows the output of <code>channel-aa.py</code> when a PJSIP channel presses <kbd>1</kbd>, <kbd>2</kbd>, <kbd>8</kbd>, then times out. Finally they hang up.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>Channel PJSIP/alice-00000001 has entered the application
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>Channel PJSIP/alice-00000001 entered 1
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>Channel PJSIP/alice-00000001 entered 2
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>Channel PJSIP/alice-00000001 entered 8
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>Channel PJSIP/alice-00000001 entered an invalid option!
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>Channel PJSIP/alice-00000001 stopped paying attention...
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>PJSIP/alice-00000001 has left the application
</span></code></pre></div> <h3 id=javascript-nodejs>JavaScript (Node.js)<a class=headerlink href=#javascript-nodejs title="Permanent link">&para;</a></h3> <p>As this example is a bit larger, how the code is written and structured is broken up into two phases:</p> <ol type=1> <li>Constructing the menu and handling its state as the user presses buttons.</li> <li>Actually handling the button presses from the user.</li> </ol> <p>The full source code for this example immediately follows the walk through.</p> <h4 id=playing-the-menu_1>Playing the menu<a class=headerlink href=#playing-the-menu_1 title="Permanent link">&para;</a></h4> <p>Unlike Playback, which can chain multiple sounds together and play them back in one continuous operation, ARI treats all sound files being played as separate operations. It will queue each sound file up to be played on the channel, and hand back the caller an object to control the operation of that single sound file. The menu announcement for the attendant has the following requirements:</p> <ol type=1> <li>Playback the options for the user</li> <li>If the user presses a DTMF key, cancel the playback of the options and handle the request</li> <li>If the user presses an invalid DTMF key, let them know and restart the menu</li> <li>If the user doesn't press anything, wait 10 seconds, ask them if they are still present, and restart the menu</li> </ol> <p>The second requirement makes this a bit more challenging: when the user presses a DTMF key, we want to cancel whatever sound file is currently being played back and immediately handle their request. We thus have to maintain some state in our application about what sound file is currently being played so that we can cancel the correct playback. We also don't want to queue up all of the sounds immediately - we'd have to walk through all of the queued up sounds and cancel each one - that'd be annoying! Instead, we only want to start the next sound in our prompt when the previous has completed.</p> <p>To start, we'll define an object to represent the menu at the top of our script that defines sounds that make up the initial menu prompt as well as valid DTMF options for the menu:</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1>1</a></span>
<span class=normal><a href=#__codelineno-15-2>2</a></span>
<span class=normal><a href=#__codelineno-15-3>3</a></span>
<span class=normal><a href=#__codelineno-15-4>4</a></span>
<span class=normal><a href=#__codelineno-15-5>5</a></span>
<span class=normal><a href=#__codelineno-15-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=kd>var</span><span class=w> </span><span class=nx>menu</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><span class=w> </span><span class=c1>// valid menu options</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a><span class=w> </span><span class=nx>options</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=mf>1</span><span class=p>,</span><span class=w> </span><span class=mf>2</span><span class=p>],</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><span class=w> </span><span class=c1>// note: this uses the &#39;extra&#39; sounds package</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><span class=w> </span><span class=nx>sounds</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sound:press-1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;sound:or&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;sound:press-2&#39;</span><span class=p>]</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>To start with, well register a callback to handle a StasisStart and StasisEnd event on any channel that enters into our application:</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1> 1</a></span>
<span class=normal><a href=#__codelineno-16-2> 2</a></span>
<span class=normal><a href=#__codelineno-16-3> 3</a></span>
<span class=normal><a href=#__codelineno-16-4> 4</a></span>
<span class=normal><a href=#__codelineno-16-5> 5</a></span>
<span class=normal><a href=#__codelineno-16-6> 6</a></span>
<span class=normal><a href=#__codelineno-16-7> 7</a></span>
<span class=normal><a href=#__codelineno-16-8> 8</a></span>
<span class=normal><a href=#__codelineno-16-9> 9</a></span>
<span class=normal><a href=#__codelineno-16-10>10</a></span>
<span class=normal><a href=#__codelineno-16-11>11</a></span>
<span class=normal><a href=#__codelineno-16-12>12</a></span>
<span class=normal><a href=#__codelineno-16-13>13</a></span>
<span class=normal><a href=#__codelineno-16-14>14</a></span>
<span class=normal><a href=#__codelineno-16-15>15</a></span>
<span class=normal><a href=#__codelineno-16-16>16</a></span>
<span class=normal><a href=#__codelineno-16-17>17</a></span>
<span class=normal><a href=#__codelineno-16-18>18</a></span>
<span class=normal><a href=#__codelineno-16-19>19</a></span>
<span class=normal><a href=#__codelineno-16-20>20</a></span>
<span class=normal><a href=#__codelineno-16-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><span class=kd>function</span><span class=w> </span><span class=nx>stasisStart</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s has entered the application&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>dtmfReceived</span><span class=p>);</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>answer</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12></a><span class=p>}</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13></a>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14></a><span class=c1>// Handler for StasisEnd event</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15></a><span class=kd>function</span><span class=w> </span><span class=nx>stasisEnd</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s has left the application&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17></a>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18></a><span class=w> </span><span class=c1>// clean up listeners</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>removeListener</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>dtmfReceived</span><span class=p>);</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20></a><span class=w> </span><span class=nx>cancelTimeout</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Note that we register a callback to handle ChannelDtmfReceived events on a channel entering our application in StasisStart and then unregister that callback on StasisEnd. For long running, non-trivial applications, this allows the JavaScript garbage collector to clean up our callback. This is important since every channel entering into our application will register its own copy of the callback which is not be garbage collected until it is unregistered.</p> <p>We'll cover the DTMF callback handler shortly, but first we'll cover writting functions to handle playing the menu prompt</p> <p>First we'll write a function to initialize a new instance of our menu; playIntroMenu.</p> <p>Since we'll want to maintain some state, we'll create a small object to do that for us. This object will keep track of the following:</p> <ol type=1> <li>The current sound being played</li> <li>The current Playback object being played</li> <li>Whether or not this menu instance is done</li> </ol> <p>It's useful to have this data, as we may cancel the menu half-way through and want to take one set of actions, or we may play all the sounds that make up the menu prompt and start a different set of actions.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1>1</a></span>
<span class=normal><a href=#__codelineno-17-2>2</a></span>
<span class=normal><a href=#__codelineno-17-3>3</a></span>
<span class=normal><a href=#__codelineno-17-4>4</a></span>
<span class=normal><a href=#__codelineno-17-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><span class=kd>var</span><span class=w> </span><span class=nx>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><span class=w> </span><span class=nx>currentSound</span><span class=o>:</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>[</span><span class=mf>0</span><span class=p>],</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><span class=w> </span><span class=nx>currentPlayback</span><span class=o>:</span><span class=w> </span><span class=kc>undefined</span><span class=p>,</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><span class=w> </span><span class=nx>done</span><span class=o>:</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p><code>playIntroMenu will</code> start the menu on a channel. It will simply initialize the state of the menu, and get the ball rolling on the channel by calling <code>queueUpSound</code> which is a nested function within playIntroMenu.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1> 1</a></span>
<span class=normal><a href=#__codelineno-18-2> 2</a></span>
<span class=normal><a href=#__codelineno-18-3> 3</a></span>
<span class=normal><a href=#__codelineno-18-4> 4</a></span>
<span class=normal><a href=#__codelineno-18-5> 5</a></span>
<span class=normal><a href=#__codelineno-18-6> 6</a></span>
<span class=normal><a href=#__codelineno-18-7> 7</a></span>
<span class=normal><a href=#__codelineno-18-8> 8</a></span>
<span class=normal><a href=#__codelineno-18-9> 9</a></span>
<span class=normal><a href=#__codelineno-18-10>10</a></span>
<span class=normal><a href=#__codelineno-18-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><span class=kd>function</span><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a><span class=w> </span><span class=nx>currentSound</span><span class=o>:</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>[</span><span class=mf>0</span><span class=p>],</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><span class=w> </span><span class=nx>currentPlayback</span><span class=o>:</span><span class=w> </span><span class=kc>undefined</span><span class=p>,</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a><span class=w> </span><span class=nx>done</span><span class=o>:</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><span class=w> </span><span class=p>};</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a><span class=w>  </span><span class=nx>channel</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a><span class=w> </span><span class=nx>queueUpSound</span><span class=p>();</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11></a><span class=w> </span><span class=p>...</span>
</span></code></pre></div></td></tr></table></div> <p>We'll cover cancelMenu shortly, but first let's discuss queueUpSound. <code>queueUpSound</code> will be responsible for starting the next sound file on the channel and handling the manipulation of that sound file. queueUpSound is also responsible for starting a timeout once all sounds for the menu prompt have completed to handle reminding the user that they must choose a menu option. We'll cover that part shortly but first, we'll cover handling progerssing through the sounds that make up the menu prompt. We first initiate playback on the current sound in the sequence. We then register a callback to handle that playback finishing, which will trigger queueUpSound to be called again, moving on to the next sound in the sequence. Finally, we update the state object to reflect the next sound to be played in the menu prompt sequence.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1> 1</a></span>
<span class=normal><a href=#__codelineno-19-2> 2</a></span>
<span class=normal><a href=#__codelineno-19-3> 3</a></span>
<span class=normal><a href=#__codelineno-19-4> 4</a></span>
<span class=normal><a href=#__codelineno-19-5> 5</a></span>
<span class=normal><a href=#__codelineno-19-6> 6</a></span>
<span class=normal><a href=#__codelineno-19-7> 7</a></span>
<span class=normal><a href=#__codelineno-19-8> 8</a></span>
<span class=normal><a href=#__codelineno-19-9> 9</a></span>
<span class=normal><a href=#__codelineno-19-10>10</a></span>
<span class=normal><a href=#__codelineno-19-11>11</a></span>
<span class=normal><a href=#__codelineno-19-12>12</a></span>
<span class=normal><a href=#__codelineno-19-13>13</a></span>
<span class=normal><a href=#__codelineno-19-14>14</a></span>
<span class=normal><a href=#__codelineno-19-15>15</a></span>
<span class=normal><a href=#__codelineno-19-16>16</a></span>
<span class=normal><a href=#__codelineno-19-17>17</a></span>
<span class=normal><a href=#__codelineno-19-18>18</a></span>
<span class=normal><a href=#__codelineno-19-19>19</a></span>
<span class=normal><a href=#__codelineno-19-20>20</a></span>
<span class=normal><a href=#__codelineno-19-21>21</a></span>
<span class=normal><a href=#__codelineno-19-22>22</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><span class=kd>function</span><span class=w> </span><span class=nx>queueUpSound</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a><span class=w> </span><span class=c1>// have we played all sounds in the menu?</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>setTimeout</span><span class=p>(</span><span class=nx>stillThere</span><span class=p>,</span><span class=w> </span><span class=mf>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>);</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a><span class=w> </span><span class=nx>timers</span><span class=p>[</span><span class=nx>channel</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>timer</span><span class=p>;</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>playback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>Playback</span><span class=p>();</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentPlayback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>playback</span><span class=p>;</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10></a>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11></a><span class=w>  </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=p>},</span><span class=w> </span><span class=nx>playback</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14></a><span class=w> </span><span class=nx>playback</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;PlaybackFinished&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>playback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15></a><span class=w> </span><span class=nx>queueUpSound</span><span class=p>();</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17></a>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18></a><span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=nx>nextSoundIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1</span><span class=p>;</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>[</span><span class=nx>nextSoundIndex</span><span class=p>];</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Notice that when registering our PlaybackFinished callback handler, we use the once method on the resource instance instead of on. This ensures that the callback will be invoked once and then automatically be unregistered. Since a PlaybackFinished event will only be invoked once for a given Playback instance, it makes sense to use this method which will also enable the callback to be garbage collected once it has been invoked.</p> <p>queueUpSound will play back the menu sounds, but it doesn't handle cancelling the menu, time-outs, or other conditions. To do that, we're going to need more information from Asterisk.</p> <h4 id=cancelling-the-menu_1>Cancelling the menu<a class=headerlink href=#cancelling-the-menu_1 title="Permanent link">&para;</a></h4> <p>When the user presses a DTMF key, we want to stop the current playback and end the menu. To do that, we'll need to subscribe for DTMF events from the channel. We'll define a new handler function, <code>cancelMenu</code>, and tell <code>ari-client</code> to call it when a DTMF key is received via the <code>ChannelDtmfReceived</code> event. We don't really care about the digit here - we just want to cancel the menu. In the handler function, we'll set <code>state.done</code> to t<code>rue</code>, then tell the <code>currentPlayback</code> to stop.</p> <p>We should also stop the menu when the channel is hung up. To do this we'll subscribe to the <code>StasisEnd</code> event as well and register cancelMenu as its callback handler:</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1> 1</a></span>
<span class=normal><a href=#__codelineno-20-2> 2</a></span>
<span class=normal><a href=#__codelineno-20-3> 3</a></span>
<span class=normal><a href=#__codelineno-20-4> 4</a></span>
<span class=normal><a href=#__codelineno-20-5> 5</a></span>
<span class=normal><a href=#__codelineno-20-6> 6</a></span>
<span class=normal><a href=#__codelineno-20-7> 7</a></span>
<span class=normal><a href=#__codelineno-20-8> 8</a></span>
<span class=normal><a href=#__codelineno-20-9> 9</a></span>
<span class=normal><a href=#__codelineno-20-10>10</a></span>
<span class=normal><a href=#__codelineno-20-11>11</a></span>
<span class=normal><a href=#__codelineno-20-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><span class=kd>function</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentPlayback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentPlayback</span><span class=p>.</span><span class=nx>stop</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8></a>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9></a><span class=w>  </span><span class=c1>// remove listeners as future calls to playIntroMenu will create new ones</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>removeListener</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>removeListener</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Note that once the cancelMenu callback is invoked, we unregister both the ChannelDtmfReceived and StasisEnd events. This is performed so that once this particular menu instance stops, we do not leave registered callbacks behind that will never be garbage collected.</p> <h4 id=timing-out_1>Timing out<a class=headerlink href=#timing-out_1 title="Permanent link">&para;</a></h4> <p>Now we can cancel the menu, but we also need to restart it if the user doesn't do anything. We can use a JavaScript timeout to start a timer if we're finished playing sounds <em>and</em> we got to the end of the sound prompt sequence. We don't want to start the timer if the user pressed a DTMF key - in that case, we would have stopped the menu early and we should be off handling their DTMF key press. The timer will call <code>stillThere</code>, which will play back a "are you still there?" prompt, then restart the menu.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1> 1</a></span>
<span class=normal><a href=#__codelineno-21-2> 2</a></span>
<span class=normal><a href=#__codelineno-21-3> 3</a></span>
<span class=normal><a href=#__codelineno-21-4> 4</a></span>
<span class=normal><a href=#__codelineno-21-5> 5</a></span>
<span class=normal><a href=#__codelineno-21-6> 6</a></span>
<span class=normal><a href=#__codelineno-21-7> 7</a></span>
<span class=normal><a href=#__codelineno-21-8> 8</a></span>
<span class=normal><a href=#__codelineno-21-9> 9</a></span>
<span class=normal><a href=#__codelineno-21-10>10</a></span>
<span class=normal><a href=#__codelineno-21-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1></a><span class=kd>function</span><span class=w> </span><span class=nx>stillThere</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s stopped paying attention...&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3></a>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sound:are-you-still-there&#39;</span><span class=p>},</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8></a>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Now that we've introduced timers, we know we're going to need to stop them if the user does something. We'll store the timers in an object indexed by channel ID, so we can get them from various parts of the script:</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1></a><span class=kd>var</span><span class=w> </span><span class=nx>timers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{};</span>
</span></code></pre></div></td></tr></table></div> <h4 id=handling-the-dtmf-options_1>Handling the DTMF options<a class=headerlink href=#handling-the-dtmf-options_1 title="Permanent link">&para;</a></h4> <p>While we now have code that plays back the menu to the user, we actually have to implement the attendant menu still. Earlier in our example we registered a callback handler for a ChannelDtmfReceived event on a channel that enters into our application. In that callback, we need to do the following:</p> <ol type=1> <li>Cancel any timers associated with the channel. Note that we don't need to stop the playback of the menu, as the menu function <code>queueUpSound</code> already registers a handler for that event and cancels the menu when it gets any digit.</li> <li>Actually handle the digit, if the digit is a <code>1</code> or a <code>2</code>.</li> <li>If the digit isn't supported, play a prompt informing the user that their option was invalid, and re-play the menu.</li> </ol> <p>The following implements these three items, deferring processing of the valid options to a separate function.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1> 1</a></span>
<span class=normal><a href=#__codelineno-23-2> 2</a></span>
<span class=normal><a href=#__codelineno-23-3> 3</a></span>
<span class=normal><a href=#__codelineno-23-4> 4</a></span>
<span class=normal><a href=#__codelineno-23-5> 5</a></span>
<span class=normal><a href=#__codelineno-23-6> 6</a></span>
<span class=normal><a href=#__codelineno-23-7> 7</a></span>
<span class=normal><a href=#__codelineno-23-8> 8</a></span>
<span class=normal><a href=#__codelineno-23-9> 9</a></span>
<span class=normal><a href=#__codelineno-23-10>10</a></span>
<span class=normal><a href=#__codelineno-23-11>11</a></span>
<span class=normal><a href=#__codelineno-23-12>12</a></span>
<span class=normal><a href=#__codelineno-23-13>13</a></span>
<span class=normal><a href=#__codelineno-23-14>14</a></span>
<span class=normal><a href=#__codelineno-23-15>15</a></span>
<span class=normal><a href=#__codelineno-23-16>16</a></span>
<span class=normal><a href=#__codelineno-23-17>17</a></span>
<span class=normal><a href=#__codelineno-23-18>18</a></span>
<span class=normal><a href=#__codelineno-23-19>19</a></span>
<span class=normal><a href=#__codelineno-23-20>20</a></span>
<span class=normal><a href=#__codelineno-23-21>21</a></span>
<span class=normal><a href=#__codelineno-23-22>22</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1></a><span class=kd>function</span><span class=w> </span><span class=nx>dtmfReceived</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2></a><span class=w> </span><span class=nx>cancelTimeout</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>digit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>parseInt</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4></a>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s entered %d&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6></a>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7></a><span class=w> </span><span class=c1>// will be non-zero if valid</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>valid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>~</span><span class=nx>menu</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>valid</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10></a><span class=w> </span><span class=nx>handleDtmf</span><span class=p>(</span><span class=nx>channel</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s entered an invalid option!&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13></a>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sound:option-is-invalid&#39;</span><span class=p>},</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>playback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18></a>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Cancelling the timer is done in a fashion similar to other examples. If the channel has a JavaScript timeout associated with it, we cancel the timer and remove it from the object.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1>1</a></span>
<span class=normal><a href=#__codelineno-24-2>2</a></span>
<span class=normal><a href=#__codelineno-24-3>3</a></span>
<span class=normal><a href=#__codelineno-24-4>4</a></span>
<span class=normal><a href=#__codelineno-24-5>5</a></span>
<span class=normal><a href=#__codelineno-24-6>6</a></span>
<span class=normal><a href=#__codelineno-24-7>7</a></span>
<span class=normal><a href=#__codelineno-24-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><span class=kd>function</span><span class=w> </span><span class=nx>cancelTimeout</span><span class=p>(</span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>timers</span><span class=p>[</span><span class=nx>channel</span><span class=p>.</span><span class=nx>id</span><span class=p>];</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>timer</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5></a><span class=w> </span><span class=nx>clearTimeout</span><span class=p>(</span><span class=nx>timer</span><span class=p>);</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6></a><span class=w> </span><span class=ow>delete</span><span class=w> </span><span class=nx>timers</span><span class=p>[</span><span class=nx>channel</span><span class=p>.</span><span class=nx>id</span><span class=p>];</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>Finally, we need to actually do <em>something</em> when the user presses a <kbd>1</kbd> or a <kbd>2</kbd>. We could do anything here - but in our case, we're merely going to play back the number that they pressed and restart the menu.</p> <div class="language-javascript highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1> 1</a></span>
<span class=normal><a href=#__codelineno-25-2> 2</a></span>
<span class=normal><a href=#__codelineno-25-3> 3</a></span>
<span class=normal><a href=#__codelineno-25-4> 4</a></span>
<span class=normal><a href=#__codelineno-25-5> 5</a></span>
<span class=normal><a href=#__codelineno-25-6> 6</a></span>
<span class=normal><a href=#__codelineno-25-7> 7</a></span>
<span class=normal><a href=#__codelineno-25-8> 8</a></span>
<span class=normal><a href=#__codelineno-25-9> 9</a></span>
<span class=normal><a href=#__codelineno-25-10>10</a></span>
<span class=normal><a href=#__codelineno-25-11>11</a></span>
<span class=normal><a href=#__codelineno-25-12>12</a></span>
<span class=normal><a href=#__codelineno-25-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><span class=kd>function</span><span class=w> </span><span class=nx>handleDtmf</span><span class=p>(</span><span class=nx>channel</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>parts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>util</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=s1>&#39;digits:%s&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>)];</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>playback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>Playback</span><span class=p>();</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>},</span><span class=w> </span><span class=nx>playback</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=nx>util</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=s1>&#39;digits:%s&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>)},</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13></a><span class=p>}</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> <h4 id=channel-aajs>channel-aa.js<a class=headerlink href=#channel-aajs title="Permanent link">&para;</a></h4> <p>The full source for <code>channel-aa.js</code> is shown below:</p> <div class="language-javascript highlight"><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>channel-aa.js</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1>  1</a></span>
<span class=normal><a href=#__codelineno-26-2>  2</a></span>
<span class=normal><a href=#__codelineno-26-3>  3</a></span>
<span class=normal><a href=#__codelineno-26-4>  4</a></span>
<span class=normal><a href=#__codelineno-26-5>  5</a></span>
<span class=normal><a href=#__codelineno-26-6>  6</a></span>
<span class=normal><a href=#__codelineno-26-7>  7</a></span>
<span class=normal><a href=#__codelineno-26-8>  8</a></span>
<span class=normal><a href=#__codelineno-26-9>  9</a></span>
<span class=normal><a href=#__codelineno-26-10> 10</a></span>
<span class=normal><a href=#__codelineno-26-11> 11</a></span>
<span class=normal><a href=#__codelineno-26-12> 12</a></span>
<span class=normal><a href=#__codelineno-26-13> 13</a></span>
<span class=normal><a href=#__codelineno-26-14> 14</a></span>
<span class=normal><a href=#__codelineno-26-15> 15</a></span>
<span class=normal><a href=#__codelineno-26-16> 16</a></span>
<span class=normal><a href=#__codelineno-26-17> 17</a></span>
<span class=normal><a href=#__codelineno-26-18> 18</a></span>
<span class=normal><a href=#__codelineno-26-19> 19</a></span>
<span class=normal><a href=#__codelineno-26-20> 20</a></span>
<span class=normal><a href=#__codelineno-26-21> 21</a></span>
<span class=normal><a href=#__codelineno-26-22> 22</a></span>
<span class=normal><a href=#__codelineno-26-23> 23</a></span>
<span class=normal><a href=#__codelineno-26-24> 24</a></span>
<span class=normal><a href=#__codelineno-26-25> 25</a></span>
<span class=normal><a href=#__codelineno-26-26> 26</a></span>
<span class=normal><a href=#__codelineno-26-27> 27</a></span>
<span class=normal><a href=#__codelineno-26-28> 28</a></span>
<span class=normal><a href=#__codelineno-26-29> 29</a></span>
<span class=normal><a href=#__codelineno-26-30> 30</a></span>
<span class=normal><a href=#__codelineno-26-31> 31</a></span>
<span class=normal><a href=#__codelineno-26-32> 32</a></span>
<span class=normal><a href=#__codelineno-26-33> 33</a></span>
<span class=normal><a href=#__codelineno-26-34> 34</a></span>
<span class=normal><a href=#__codelineno-26-35> 35</a></span>
<span class=normal><a href=#__codelineno-26-36> 36</a></span>
<span class=normal><a href=#__codelineno-26-37> 37</a></span>
<span class=normal><a href=#__codelineno-26-38> 38</a></span>
<span class=normal><a href=#__codelineno-26-39> 39</a></span>
<span class=normal><a href=#__codelineno-26-40> 40</a></span>
<span class=normal><a href=#__codelineno-26-41> 41</a></span>
<span class=normal><a href=#__codelineno-26-42> 42</a></span>
<span class=normal><a href=#__codelineno-26-43> 43</a></span>
<span class=normal><a href=#__codelineno-26-44> 44</a></span>
<span class=normal><a href=#__codelineno-26-45> 45</a></span>
<span class=normal><a href=#__codelineno-26-46> 46</a></span>
<span class=normal><a href=#__codelineno-26-47> 47</a></span>
<span class=normal><a href=#__codelineno-26-48> 48</a></span>
<span class=normal><a href=#__codelineno-26-49> 49</a></span>
<span class=normal><a href=#__codelineno-26-50> 50</a></span>
<span class=normal><a href=#__codelineno-26-51> 51</a></span>
<span class=normal><a href=#__codelineno-26-52> 52</a></span>
<span class=normal><a href=#__codelineno-26-53> 53</a></span>
<span class=normal><a href=#__codelineno-26-54> 54</a></span>
<span class=normal><a href=#__codelineno-26-55> 55</a></span>
<span class=normal><a href=#__codelineno-26-56> 56</a></span>
<span class=normal><a href=#__codelineno-26-57> 57</a></span>
<span class=normal><a href=#__codelineno-26-58> 58</a></span>
<span class=normal><a href=#__codelineno-26-59> 59</a></span>
<span class=normal><a href=#__codelineno-26-60> 60</a></span>
<span class=normal><a href=#__codelineno-26-61> 61</a></span>
<span class=normal><a href=#__codelineno-26-62> 62</a></span>
<span class=normal><a href=#__codelineno-26-63> 63</a></span>
<span class=normal><a href=#__codelineno-26-64> 64</a></span>
<span class=normal><a href=#__codelineno-26-65> 65</a></span>
<span class=normal><a href=#__codelineno-26-66> 66</a></span>
<span class=normal><a href=#__codelineno-26-67> 67</a></span>
<span class=normal><a href=#__codelineno-26-68> 68</a></span>
<span class=normal><a href=#__codelineno-26-69> 69</a></span>
<span class=normal><a href=#__codelineno-26-70> 70</a></span>
<span class=normal><a href=#__codelineno-26-71> 71</a></span>
<span class=normal><a href=#__codelineno-26-72> 72</a></span>
<span class=normal><a href=#__codelineno-26-73> 73</a></span>
<span class=normal><a href=#__codelineno-26-74> 74</a></span>
<span class=normal><a href=#__codelineno-26-75> 75</a></span>
<span class=normal><a href=#__codelineno-26-76> 76</a></span>
<span class=normal><a href=#__codelineno-26-77> 77</a></span>
<span class=normal><a href=#__codelineno-26-78> 78</a></span>
<span class=normal><a href=#__codelineno-26-79> 79</a></span>
<span class=normal><a href=#__codelineno-26-80> 80</a></span>
<span class=normal><a href=#__codelineno-26-81> 81</a></span>
<span class=normal><a href=#__codelineno-26-82> 82</a></span>
<span class=normal><a href=#__codelineno-26-83> 83</a></span>
<span class=normal><a href=#__codelineno-26-84> 84</a></span>
<span class=normal><a href=#__codelineno-26-85> 85</a></span>
<span class=normal><a href=#__codelineno-26-86> 86</a></span>
<span class=normal><a href=#__codelineno-26-87> 87</a></span>
<span class=normal><a href=#__codelineno-26-88> 88</a></span>
<span class=normal><a href=#__codelineno-26-89> 89</a></span>
<span class=normal><a href=#__codelineno-26-90> 90</a></span>
<span class=normal><a href=#__codelineno-26-91> 91</a></span>
<span class=normal><a href=#__codelineno-26-92> 92</a></span>
<span class=normal><a href=#__codelineno-26-93> 93</a></span>
<span class=normal><a href=#__codelineno-26-94> 94</a></span>
<span class=normal><a href=#__codelineno-26-95> 95</a></span>
<span class=normal><a href=#__codelineno-26-96> 96</a></span>
<span class=normal><a href=#__codelineno-26-97> 97</a></span>
<span class=normal><a href=#__codelineno-26-98> 98</a></span>
<span class=normal><a href=#__codelineno-26-99> 99</a></span>
<span class=normal><a href=#__codelineno-26-100>100</a></span>
<span class=normal><a href=#__codelineno-26-101>101</a></span>
<span class=normal><a href=#__codelineno-26-102>102</a></span>
<span class=normal><a href=#__codelineno-26-103>103</a></span>
<span class=normal><a href=#__codelineno-26-104>104</a></span>
<span class=normal><a href=#__codelineno-26-105>105</a></span>
<span class=normal><a href=#__codelineno-26-106>106</a></span>
<span class=normal><a href=#__codelineno-26-107>107</a></span>
<span class=normal><a href=#__codelineno-26-108>108</a></span>
<span class=normal><a href=#__codelineno-26-109>109</a></span>
<span class=normal><a href=#__codelineno-26-110>110</a></span>
<span class=normal><a href=#__codelineno-26-111>111</a></span>
<span class=normal><a href=#__codelineno-26-112>112</a></span>
<span class=normal><a href=#__codelineno-26-113>113</a></span>
<span class=normal><a href=#__codelineno-26-114>114</a></span>
<span class=normal><a href=#__codelineno-26-115>115</a></span>
<span class=normal><a href=#__codelineno-26-116>116</a></span>
<span class=normal><a href=#__codelineno-26-117>117</a></span>
<span class=normal><a href=#__codelineno-26-118>118</a></span>
<span class=normal><a href=#__codelineno-26-119>119</a></span>
<span class=normal><a href=#__codelineno-26-120>120</a></span>
<span class=normal><a href=#__codelineno-26-121>121</a></span>
<span class=normal><a href=#__codelineno-26-122>122</a></span>
<span class=normal><a href=#__codelineno-26-123>123</a></span>
<span class=normal><a href=#__codelineno-26-124>124</a></span>
<span class=normal><a href=#__codelineno-26-125>125</a></span>
<span class=normal><a href=#__codelineno-26-126>126</a></span>
<span class=normal><a href=#__codelineno-26-127>127</a></span>
<span class=normal><a href=#__codelineno-26-128>128</a></span>
<span class=normal><a href=#__codelineno-26-129>129</a></span>
<span class=normal><a href=#__codelineno-26-130>130</a></span>
<span class=normal><a href=#__codelineno-26-131>131</a></span>
<span class=normal><a href=#__codelineno-26-132>132</a></span>
<span class=normal><a href=#__codelineno-26-133>133</a></span>
<span class=normal><a href=#__codelineno-26-134>134</a></span>
<span class=normal><a href=#__codelineno-26-135>135</a></span>
<span class=normal><a href=#__codelineno-26-136>136</a></span>
<span class=normal><a href=#__codelineno-26-137>137</a></span>
<span class=normal><a href=#__codelineno-26-138>138</a></span>
<span class=normal><a href=#__codelineno-26-139>139</a></span>
<span class=normal><a href=#__codelineno-26-140>140</a></span>
<span class=normal><a href=#__codelineno-26-141>141</a></span>
<span class=normal><a href=#__codelineno-26-142>142</a></span>
<span class=normal><a href=#__codelineno-26-143>143</a></span>
<span class=normal><a href=#__codelineno-26-144>144</a></span>
<span class=normal><a href=#__codelineno-26-145>145</a></span>
<span class=normal><a href=#__codelineno-26-146>146</a></span>
<span class=normal><a href=#__codelineno-26-147>147</a></span>
<span class=normal><a href=#__codelineno-26-148>148</a></span>
<span class=normal><a href=#__codelineno-26-149>149</a></span>
<span class=normal><a href=#__codelineno-26-150>150</a></span>
<span class=normal><a href=#__codelineno-26-151>151</a></span>
<span class=normal><a href=#__codelineno-26-152>152</a></span>
<span class=normal><a href=#__codelineno-26-153>153</a></span>
<span class=normal><a href=#__codelineno-26-154>154</a></span>
<span class=normal><a href=#__codelineno-26-155>155</a></span>
<span class=normal><a href=#__codelineno-26-156>156</a></span>
<span class=normal><a href=#__codelineno-26-157>157</a></span>
<span class=normal><a href=#__codelineno-26-158>158</a></span>
<span class=normal><a href=#__codelineno-26-159>159</a></span>
<span class=normal><a href=#__codelineno-26-160>160</a></span>
<span class=normal><a href=#__codelineno-26-161>161</a></span>
<span class=normal><a href=#__codelineno-26-162>162</a></span>
<span class=normal><a href=#__codelineno-26-163>163</a></span>
<span class=normal><a href=#__codelineno-26-164>164</a></span>
<span class=normal><a href=#__codelineno-26-165>165</a></span>
<span class=normal><a href=#__codelineno-26-166>166</a></span>
<span class=normal><a href=#__codelineno-26-167>167</a></span>
<span class=normal><a href=#__codelineno-26-168>168</a></span>
<span class=normal><a href=#__codelineno-26-169>169</a></span>
<span class=normal><a href=#__codelineno-26-170>170</a></span>
<span class=normal><a href=#__codelineno-26-171>171</a></span>
<span class=normal><a href=#__codelineno-26-172>172</a></span>
<span class=normal><a href=#__codelineno-26-173>173</a></span>
<span class=normal><a href=#__codelineno-26-174>174</a></span>
<span class=normal><a href=#__codelineno-26-175>175</a></span>
<span class=normal><a href=#__codelineno-26-176>176</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><span class=cm>/*jshint node:true */</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2></a><span class=s1>&#39;use strict&#39;</span><span class=p>;</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3></a>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4></a><span class=kd>var</span><span class=w> </span><span class=nx>ari</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;ari-client&#39;</span><span class=p>);</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5></a><span class=kd>var</span><span class=w> </span><span class=nx>util</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;util&#39;</span><span class=p>);</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6></a>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7></a><span class=nx>ari</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=s1>&#39;http://localhost:8088&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;asterisk&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;asterisk&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>clientLoaded</span><span class=p>);</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8></a>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9></a><span class=kd>var</span><span class=w> </span><span class=nx>menu</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10></a><span class=w> </span><span class=c1>// valid menu options</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11></a><span class=w> </span><span class=nx>options</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=mf>1</span><span class=p>,</span><span class=w> </span><span class=mf>2</span><span class=p>],</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12></a><span class=w> </span><span class=c1>// note: this uses the &#39;extra&#39; sounds package</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13></a><span class=w> </span><span class=nx>sounds</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sound:press-1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;sound:or&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;sound:press-2&#39;</span><span class=p>]</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14></a><span class=p>};</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15></a>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16></a><span class=kd>var</span><span class=w> </span><span class=nx>timers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{};</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17></a>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18></a><span class=c1>// Handler for client being loaded</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19></a><span class=kd>function</span><span class=w> </span><span class=nx>clientLoaded</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23></a>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24></a><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;StasisStart&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>stasisStart</span><span class=p>);</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25></a><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>stasisEnd</span><span class=p>);</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26></a>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27></a><span class=w> </span><span class=c1>// Handler for StasisStart event</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>stasisStart</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s has entered the application&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30></a>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>dtmfReceived</span><span class=p>);</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32></a>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>answer</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-34><a id=__codelineno-26-34 name=__codelineno-26-34></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-35><a id=__codelineno-26-35 name=__codelineno-26-35></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-26-36><a id=__codelineno-26-36 name=__codelineno-26-36></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-37><a id=__codelineno-26-37 name=__codelineno-26-37></a>
</span><span id=__span-26-38><a id=__codelineno-26-38 name=__codelineno-26-38></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-26-39><a id=__codelineno-26-39 name=__codelineno-26-39></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-40><a id=__codelineno-26-40 name=__codelineno-26-40></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-41><a id=__codelineno-26-41 name=__codelineno-26-41></a>
</span><span id=__span-26-42><a id=__codelineno-26-42 name=__codelineno-26-42></a><span class=w> </span><span class=c1>// Handler for StasisEnd event</span>
</span><span id=__span-26-43><a id=__codelineno-26-43 name=__codelineno-26-43></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>stasisEnd</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-44><a id=__codelineno-26-44 name=__codelineno-26-44></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s has left the application&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-26-45><a id=__codelineno-26-45 name=__codelineno-26-45></a>
</span><span id=__span-26-46><a id=__codelineno-26-46 name=__codelineno-26-46></a><span class=w> </span><span class=c1>// clean up listeners</span>
</span><span id=__span-26-47><a id=__codelineno-26-47 name=__codelineno-26-47></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>removeListener</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>dtmfReceived</span><span class=p>);</span>
</span><span id=__span-26-48><a id=__codelineno-26-48 name=__codelineno-26-48></a><span class=w> </span><span class=nx>cancelTimeout</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-26-49><a id=__codelineno-26-49 name=__codelineno-26-49></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-50><a id=__codelineno-26-50 name=__codelineno-26-50></a>
</span><span id=__span-26-51><a id=__codelineno-26-51 name=__codelineno-26-51></a><span class=w> </span><span class=c1>// Main DTMF handler</span>
</span><span id=__span-26-52><a id=__codelineno-26-52 name=__codelineno-26-52></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>dtmfReceived</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-53><a id=__codelineno-26-53 name=__codelineno-26-53></a><span class=w> </span><span class=nx>cancelTimeout</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-26-54><a id=__codelineno-26-54 name=__codelineno-26-54></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>digit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>parseInt</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-26-55><a id=__codelineno-26-55 name=__codelineno-26-55></a>
</span><span id=__span-26-56><a id=__codelineno-26-56 name=__codelineno-26-56></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s entered %d&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-26-57><a id=__codelineno-26-57 name=__codelineno-26-57></a>
</span><span id=__span-26-58><a id=__codelineno-26-58 name=__codelineno-26-58></a><span class=w> </span><span class=c1>// will be non-zero if valid</span>
</span><span id=__span-26-59><a id=__codelineno-26-59 name=__codelineno-26-59></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>valid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>~</span><span class=nx>menu</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-26-60><a id=__codelineno-26-60 name=__codelineno-26-60></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>valid</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-61><a id=__codelineno-26-61 name=__codelineno-26-61></a><span class=w> </span><span class=nx>handleDtmf</span><span class=p>(</span><span class=nx>channel</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>);</span>
</span><span id=__span-26-62><a id=__codelineno-26-62 name=__codelineno-26-62></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-63><a id=__codelineno-26-63 name=__codelineno-26-63></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s entered an invalid option!&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-26-64><a id=__codelineno-26-64 name=__codelineno-26-64></a>
</span><span id=__span-26-65><a id=__codelineno-26-65 name=__codelineno-26-65></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sound:option-is-invalid&#39;</span><span class=p>},</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>playback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-66><a id=__codelineno-26-66 name=__codelineno-26-66></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-67><a id=__codelineno-26-67 name=__codelineno-26-67></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-26-68><a id=__codelineno-26-68 name=__codelineno-26-68></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-69><a id=__codelineno-26-69 name=__codelineno-26-69></a>
</span><span id=__span-26-70><a id=__codelineno-26-70 name=__codelineno-26-70></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-26-71><a id=__codelineno-26-71 name=__codelineno-26-71></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-72><a id=__codelineno-26-72 name=__codelineno-26-72></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-73><a id=__codelineno-26-73 name=__codelineno-26-73></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-74><a id=__codelineno-26-74 name=__codelineno-26-74></a>
</span><span id=__span-26-75><a id=__codelineno-26-75 name=__codelineno-26-75></a><span class=w> </span><span class=cm>/**</span>
</span><span id=__span-26-76><a id=__codelineno-26-76 name=__codelineno-26-76></a><span class=cm> * Play our intro menu to the specified channel</span>
</span><span id=__span-26-77><a id=__codelineno-26-77 name=__codelineno-26-77></a><span class=cm> * </span>
</span><span id=__span-26-78><a id=__codelineno-26-78 name=__codelineno-26-78></a><span class=cm> * Since we want to interrupt the playback of the menu when the user presses</span>
</span><span id=__span-26-79><a id=__codelineno-26-79 name=__codelineno-26-79></a><span class=cm> * a DTMF key, we maintain the state of the menu via the MenuState object.</span>
</span><span id=__span-26-80><a id=__codelineno-26-80 name=__codelineno-26-80></a><span class=cm> * A menu completes in one of two ways:</span>
</span><span id=__span-26-81><a id=__codelineno-26-81 name=__codelineno-26-81></a><span class=cm> * (1) The user hits a key</span>
</span><span id=__span-26-82><a id=__codelineno-26-82 name=__codelineno-26-82></a><span class=cm> * (2) The menu finishes to completion</span>
</span><span id=__span-26-83><a id=__codelineno-26-83 name=__codelineno-26-83></a><span class=cm> *</span>
</span><span id=__span-26-84><a id=__codelineno-26-84 name=__codelineno-26-84></a><span class=cm> * In the case of (2), a timer is started for the channel. If the timer pops,</span>
</span><span id=__span-26-85><a id=__codelineno-26-85 name=__codelineno-26-85></a><span class=cm> * a prompt is played back and the menu restarted.</span>
</span><span id=__span-26-86><a id=__codelineno-26-86 name=__codelineno-26-86></a><span class=cm> * */</span>
</span><span id=__span-26-87><a id=__codelineno-26-87 name=__codelineno-26-87></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-88><a id=__codelineno-26-88 name=__codelineno-26-88></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-89><a id=__codelineno-26-89 name=__codelineno-26-89></a><span class=w> </span><span class=nx>currentSound</span><span class=o>:</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>[</span><span class=mf>0</span><span class=p>],</span>
</span><span id=__span-26-90><a id=__codelineno-26-90 name=__codelineno-26-90></a><span class=w> </span><span class=nx>currentPlayback</span><span class=o>:</span><span class=w> </span><span class=kc>undefined</span><span class=p>,</span>
</span><span id=__span-26-91><a id=__codelineno-26-91 name=__codelineno-26-91></a><span class=w> </span><span class=nx>done</span><span class=o>:</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-26-92><a id=__codelineno-26-92 name=__codelineno-26-92></a><span class=w> </span><span class=p>};</span>
</span><span id=__span-26-93><a id=__codelineno-26-93 name=__codelineno-26-93></a>
</span><span id=__span-26-94><a id=__codelineno-26-94 name=__codelineno-26-94></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-26-95><a id=__codelineno-26-95 name=__codelineno-26-95></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-26-96><a id=__codelineno-26-96 name=__codelineno-26-96></a><span class=w> </span><span class=nx>queueUpSound</span><span class=p>();</span>
</span><span id=__span-26-97><a id=__codelineno-26-97 name=__codelineno-26-97></a>
</span><span id=__span-26-98><a id=__codelineno-26-98 name=__codelineno-26-98></a><span class=w> </span><span class=c1>// Cancel the menu, as the user did something</span>
</span><span id=__span-26-99><a id=__codelineno-26-99 name=__codelineno-26-99></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-100><a id=__codelineno-26-100 name=__codelineno-26-100></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-26-101><a id=__codelineno-26-101 name=__codelineno-26-101></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentPlayback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-102><a id=__codelineno-26-102 name=__codelineno-26-102></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentPlayback</span><span class=p>.</span><span class=nx>stop</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-103><a id=__codelineno-26-103 name=__codelineno-26-103></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-26-104><a id=__codelineno-26-104 name=__codelineno-26-104></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-105><a id=__codelineno-26-105 name=__codelineno-26-105></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-106><a id=__codelineno-26-106 name=__codelineno-26-106></a>
</span><span id=__span-26-107><a id=__codelineno-26-107 name=__codelineno-26-107></a><span class=w> </span><span class=c1>// remove listeners as future calls to playIntroMenu will create new ones</span>
</span><span id=__span-26-108><a id=__codelineno-26-108 name=__codelineno-26-108></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>removeListener</span><span class=p>(</span><span class=s1>&#39;ChannelDtmfReceived&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-26-109><a id=__codelineno-26-109 name=__codelineno-26-109></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>removeListener</span><span class=p>(</span><span class=s1>&#39;StasisEnd&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cancelMenu</span><span class=p>);</span>
</span><span id=__span-26-110><a id=__codelineno-26-110 name=__codelineno-26-110></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-111><a id=__codelineno-26-111 name=__codelineno-26-111></a>
</span><span id=__span-26-112><a id=__codelineno-26-112 name=__codelineno-26-112></a><span class=w> </span><span class=c1>// Start up the next sound and handle whatever happens</span>
</span><span id=__span-26-113><a id=__codelineno-26-113 name=__codelineno-26-113></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>queueUpSound</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-114><a id=__codelineno-26-114 name=__codelineno-26-114></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-115><a id=__codelineno-26-115 name=__codelineno-26-115></a><span class=w> </span><span class=c1>// have we played all sounds in the menu?</span>
</span><span id=__span-26-116><a id=__codelineno-26-116 name=__codelineno-26-116></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-117><a id=__codelineno-26-117 name=__codelineno-26-117></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>setTimeout</span><span class=p>(</span><span class=nx>stillThere</span><span class=p>,</span><span class=w> </span><span class=mf>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>);</span>
</span><span id=__span-26-118><a id=__codelineno-26-118 name=__codelineno-26-118></a><span class=w> </span><span class=nx>timers</span><span class=p>[</span><span class=nx>channel</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>timer</span><span class=p>;</span>
</span><span id=__span-26-119><a id=__codelineno-26-119 name=__codelineno-26-119></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-120><a id=__codelineno-26-120 name=__codelineno-26-120></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>playback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>Playback</span><span class=p>();</span>
</span><span id=__span-26-121><a id=__codelineno-26-121 name=__codelineno-26-121></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentPlayback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>playback</span><span class=p>;</span>
</span><span id=__span-26-122><a id=__codelineno-26-122 name=__codelineno-26-122></a>
</span><span id=__span-26-123><a id=__codelineno-26-123 name=__codelineno-26-123></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=p>},</span><span class=w> </span><span class=nx>playback</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-124><a id=__codelineno-26-124 name=__codelineno-26-124></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-26-125><a id=__codelineno-26-125 name=__codelineno-26-125></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-126><a id=__codelineno-26-126 name=__codelineno-26-126></a><span class=w> </span><span class=nx>playback</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;PlaybackFinished&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>playback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-127><a id=__codelineno-26-127 name=__codelineno-26-127></a><span class=w> </span><span class=nx>queueUpSound</span><span class=p>();</span>
</span><span id=__span-26-128><a id=__codelineno-26-128 name=__codelineno-26-128></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-129><a id=__codelineno-26-129 name=__codelineno-26-129></a>
</span><span id=__span-26-130><a id=__codelineno-26-130 name=__codelineno-26-130></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>nextSoundIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1</span><span class=p>;</span>
</span><span id=__span-26-131><a id=__codelineno-26-131 name=__codelineno-26-131></a><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>currentSound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>menu</span><span class=p>.</span><span class=nx>sounds</span><span class=p>[</span><span class=nx>nextSoundIndex</span><span class=p>];</span>
</span><span id=__span-26-132><a id=__codelineno-26-132 name=__codelineno-26-132></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-133><a id=__codelineno-26-133 name=__codelineno-26-133></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-134><a id=__codelineno-26-134 name=__codelineno-26-134></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-135><a id=__codelineno-26-135 name=__codelineno-26-135></a>
</span><span id=__span-26-136><a id=__codelineno-26-136 name=__codelineno-26-136></a><span class=w> </span><span class=c1>// plays are-you-still-there and restarts the menu</span>
</span><span id=__span-26-137><a id=__codelineno-26-137 name=__codelineno-26-137></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>stillThere</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-138><a id=__codelineno-26-138 name=__codelineno-26-138></a><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Channel %s stopped paying attention...&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span><span id=__span-26-139><a id=__codelineno-26-139 name=__codelineno-26-139></a>
</span><span id=__span-26-140><a id=__codelineno-26-140 name=__codelineno-26-140></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sound:are-you-still-there&#39;</span><span class=p>},</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-141><a id=__codelineno-26-141 name=__codelineno-26-141></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-142><a id=__codelineno-26-142 name=__codelineno-26-142></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span><span class=p>;</span>
</span><span id=__span-26-143><a id=__codelineno-26-143 name=__codelineno-26-143></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-144><a id=__codelineno-26-144 name=__codelineno-26-144></a>
</span><span id=__span-26-145><a id=__codelineno-26-145 name=__codelineno-26-145></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-26-146><a id=__codelineno-26-146 name=__codelineno-26-146></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-147><a id=__codelineno-26-147 name=__codelineno-26-147></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-148><a id=__codelineno-26-148 name=__codelineno-26-148></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-149><a id=__codelineno-26-149 name=__codelineno-26-149></a>
</span><span id=__span-26-150><a id=__codelineno-26-150 name=__codelineno-26-150></a><span class=w> </span><span class=c1>// Cancel the timeout for the channel</span>
</span><span id=__span-26-151><a id=__codelineno-26-151 name=__codelineno-26-151></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>cancelTimeout</span><span class=p>(</span><span class=nx>channel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-152><a id=__codelineno-26-152 name=__codelineno-26-152></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>timers</span><span class=p>[</span><span class=nx>channel</span><span class=p>.</span><span class=nx>id</span><span class=p>];</span>
</span><span id=__span-26-153><a id=__codelineno-26-153 name=__codelineno-26-153></a>
</span><span id=__span-26-154><a id=__codelineno-26-154 name=__codelineno-26-154></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>timer</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-155><a id=__codelineno-26-155 name=__codelineno-26-155></a><span class=w> </span><span class=nx>clearTimeout</span><span class=p>(</span><span class=nx>timer</span><span class=p>);</span>
</span><span id=__span-26-156><a id=__codelineno-26-156 name=__codelineno-26-156></a><span class=w> </span><span class=ow>delete</span><span class=w> </span><span class=nx>timers</span><span class=p>[</span><span class=nx>channel</span><span class=p>.</span><span class=nx>id</span><span class=p>];</span>
</span><span id=__span-26-157><a id=__codelineno-26-157 name=__codelineno-26-157></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-158><a id=__codelineno-26-158 name=__codelineno-26-158></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-159><a id=__codelineno-26-159 name=__codelineno-26-159></a>
</span><span id=__span-26-160><a id=__codelineno-26-160 name=__codelineno-26-160></a><span class=w> </span><span class=c1>// Handler for channel pressing valid option</span>
</span><span id=__span-26-161><a id=__codelineno-26-161 name=__codelineno-26-161></a><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>handleDtmf</span><span class=p>(</span><span class=nx>channel</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-162><a id=__codelineno-26-162 name=__codelineno-26-162></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>parts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>util</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=s1>&#39;digits:%s&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>)];</span>
</span><span id=__span-26-163><a id=__codelineno-26-163 name=__codelineno-26-163></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>done</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span>
</span><span id=__span-26-164><a id=__codelineno-26-164 name=__codelineno-26-164></a>
</span><span id=__span-26-165><a id=__codelineno-26-165 name=__codelineno-26-165></a><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=nx>playback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>Playback</span><span class=p>();</span>
</span><span id=__span-26-166><a id=__codelineno-26-166 name=__codelineno-26-166></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;sound:you-entered&#39;</span><span class=p>},</span><span class=w> </span><span class=nx>playback</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-167><a id=__codelineno-26-167 name=__codelineno-26-167></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-26-168><a id=__codelineno-26-168 name=__codelineno-26-168></a><span class=w> </span><span class=nx>channel</span><span class=p>.</span><span class=nx>play</span><span class=p>({</span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=nx>util</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=s1>&#39;digits:%s&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>digit</span><span class=p>)},</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-169><a id=__codelineno-26-169 name=__codelineno-26-169></a><span class=w> </span><span class=c1>// ignore errors</span>
</span><span id=__span-26-170><a id=__codelineno-26-170 name=__codelineno-26-170></a><span class=w> </span><span class=nx>playIntroMenu</span><span class=p>(</span><span class=nx>channel</span><span class=p>);</span>
</span><span id=__span-26-171><a id=__codelineno-26-171 name=__codelineno-26-171></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-172><a id=__codelineno-26-172 name=__codelineno-26-172></a><span class=w> </span><span class=p>});</span>
</span><span id=__span-26-173><a id=__codelineno-26-173 name=__codelineno-26-173></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-26-174><a id=__codelineno-26-174 name=__codelineno-26-174></a>
</span><span id=__span-26-175><a id=__codelineno-26-175 name=__codelineno-26-175></a><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>start</span><span class=p>(</span><span class=s1>&#39;channel-aa&#39;</span><span class=p>);</span>
</span><span id=__span-26-176><a id=__codelineno-26-176 name=__codelineno-26-176></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=channel-aajs-in-action>channel-aa.js in action<a class=headerlink href=#channel-aajs-in-action title="Permanent link">&para;</a></h4> <p>The following shows the output of <code>channel-aa.js</code> when a PJSIP channel presses <kbd>1</kbd>, <kbd>2</kbd>, <kbd>8</kbd>, then times out. Finally they hang up.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>Channel PJSIP/alice-00000001 has entered the application
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>Channel PJSIP/alice-00000001 entered 1
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>Channel PJSIP/alice-00000001 entered 2
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>Channel PJSIP/alice-00000001 entered 8
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>Channel PJSIP/alice-00000001 entered an invalid option!
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>Channel PJSIP/alice-00000001 stopped paying attention...
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>PJSIP/alice-00000001 has left the application
</span></code></pre></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Content is licensed under a Creative Commons Attribution-ShareAlike 3.0 United States License. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://www.asterisk.org/ target=_blank rel=noopener title=www.asterisk.org class=md-social__link> <?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg version=1.1 id=svg2 width=48 height=48 viewbox="0 0 48 48" sodipodi:docname=favicon.svg inkscape:version="1.2.2 (b0a8486541, 2022-12-01)" xmlns:inkscape=http://www.inkscape.org/namespaces/inkscape xmlns:sodipodi=http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd xmlns:xlink=http://www.w3.org/1999/xlink xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg> <defs id=defs6 /> <sodipodi:namedview id=namedview4 pagecolor=#ffffff bordercolor=#666666 borderopacity=1.0 inkscape:showpageshadow=2 inkscape:pageopacity=0.0 inkscape:pagecheckerboard=0 inkscape:deskcolor=#d1d1d1 showgrid=false inkscape:zoom=17.291667 inkscape:cx=24 inkscape:cy=24.028916 inkscape:current-layer=g8 /> <g inkscape:groupmode=layer inkscape:label=Image id=g8> <image width=48 height=48 preserveaspectratio=none id=image10 xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAACzxJREFU
aIHtmXuQXNVxxn997jz3qRdasay0s5IMiQCDIx4JqaSwjQFDoGIXAhUVMAajgF0kAWShB48xDy2W
eLmoOLbsFBHGBahcgYTEBAJBhYNLxsjEWKEko6BdJCEJSWi1O7O7M3Pv+fLHvmZ3Z1YrYZJ/+Kqm
am6fPt393XNud5974RN8go8E+ziNK4s70HtSbTpWrCl5pdMxFy9FYdx8EBdRKBcrxeWLUUR/nyXz
M2q25S2LPxofHwuB/LLZzVEQnGXyp2HuJEythh0PTAXSoADMA33AIcFeEzvMsRVpc6RwU3377g/3
LW2qmfXAvvz/CQEJy9/ZcorC2DeccZ5gOtAAuEGVItIHODuIKCDiGNMMZgmSgzoeowuxXfgHEwrf
Kvj4tM3pztc/myX8WAgom0kVC35uyexWwxYLUkAXsB/pVx694nz0evchvdO87v3esfN33tySnl4T
P7XkdbEzLjXIAI2ASTwdmH8NXCxU6fGG9t0Hf6cE+pZnMnLc4I2vmDRDst/g+HeTXhXujdrVOz4w
0GTtHbxpfkO6rnSezK4GLhTEgP/00i9jxqySi+5uvHfXO78TAodXzr4gwD2CbJ4ZuyTucS58Mb2/
6QNbt7l0rHYF1n1zy9QgHVwH3A+GxFbQf5jZjND7r0+5/71Dx0xAS5tq8/H09Rh3I/I4Hi+GbvW0
b797+FiDrobcisxXZTxi0IB4E6MGaV3t6s6HzQZW9qgIdK84Ybpz8TsRfwG8JvRwXaLzZzbmAeu5
Y87JLuScclkEexra3/uXo/Gnm1vS+bS7A9wtCDD2AnUu4OKaezp+MWkCyuLyxZnHQc0PQJ8DvisV
1ta3791fmWjb9YHpO6OEppdr7+u85GgIAOz/m9bj0zX2b8CngSIQk/RKV390yeyHd/W5iSYruyBx
YNnxv0+xtQnSDwj+1MTq2kTnymrBAzgUCtKjfxO6qorjHunc46RvAR5IAM7MTm9IB+cO+Jog+Fx/
9zn1ybjrxe5CnOvEbTXJzvuHtowWEVRh0D/OnihUUt1QzUYZ0gc7n0O8WSaaGsjO3ZJdkKhKoKfQ
c7ZzwfxS6JYIFoM9uCNZ89hQqd9xTSaVn5/5cX757DM1ZivKa1ywJj+OVO+yE1ouOrH1sdzKzOkT
EbB1lDB+VCZyzrTwZLoaKhLov735pJhzWYNGjKtMPFV7sONvT8m+XQTQBoKZzdyGcYVc7Kd9y1u/
0Z1tnjFExAXjV8DKVkVLm2pzt2cu9LH4C8iuQjykZSfVT0SCyDZStorCTuwP4/XjCPSuap4d+sT3
Q29veLgS089rvLvN1jGc2/t+3bJQ6GuDpmZ4Z9+xYuKJ3hWtX9ySXZCotAJeFJTF5VZmTu9NpB/C
6yfAAgCZzuwN+i+vuiWBwHTYjD3DBMQs52O1owgouyAhxa8HjnfYCcIapdhyK8vxe5c21Uqx68Ca
y6Y6g/Nl9nim0LsWXGxsACYr9hdbrzH0E+A6sNrhMaxOZkt6P9U6sxoBn4qKEsMFDCNeME0ZRaC3
P3+ysK9JvI9pkTP9Q11i9tZynVQqNVPGn1TwYcB0jL8Cnq4wem2E/b2weWLcnRZwYmT8YTUCFJ1g
dL2Jex8ME3glS8w7uws4HlgIdIRR9JRlN46a1PjpzveiEtcKfiDK7shoNFaQNVTRLZnpX510XX3c
nq8Wv1nkGEijQ/De1DNMYGGh7SJDFw8oU2/GUw3tu/5nnKHLiRrXdGyqSxRvCUIuQnoJiKo5PgK2
Ofkrw3j0lXR75zOW7Rj38I8QCBJmTB26FnQHLuiJwUBLnCvqVrChvduH9L2hfqOiwez7vcCmHdnM
JTNLXANaKm9zMOJHCNpjfCDPBjNbXdP+3r7JMI28NRo0DV07o9Or2OsAevr8GQYnlbF7sXZ1555K
hsaiLdvRvzbesU5m92F0HUnfoCTPU3XJ4oq61TsmFfzgvLPKDj54z7a+eKrHCcwFdjYwbZiA16Sb
rt5VLSd8s9T6PcT9DJzCJoQgiXFtvph4Nr9q7hnSZBtKXVr2PxS8OY3tuRjZ5jRFOwUGlt5QGMHm
CU0J61naPD0ej1/gPXfLbO7kghiADTzQX5D8Wb23tz7auyq2Lh2fvWdswhhCftnsZmFfGAnAPowT
vWZZvMvl0nUSbcNj0JUm6qnmfOfNLenciszlLpl4IjJbf7TBj0GjZLd7hT/NF3f8dW5lW1NFrcDd
SFkGEnorlYw2A7ggSRIbeTgM6+2PBVWzyvRE4jhzuhM4H6tcOSul1wlSLmCnAN/Cc9rYkUPLMxlv
dnm5zBsPDSYRnFkYM1RX5iiZwldt8tLp1F7QP4HGkvSIvZJWx/CLKrBaH1q0GPQ2aOxWEfCqt+Ko
ratFBHHTZQatw1ThhcbVncP1whVCGWXdpMGU0AdVGyvLvl30LlgPtr3MfUHS0/LRFXXJtrsqz1Sy
8d6dG3xY+rLDHgTKM1CXl62rb9/9YfmM7nktbWBXM5R9xN5I/p5yHZcMgsiwkU5xQHnC9rb+nh2/
9Wjt4OU2c1xRl4zfUP/tna9admPosdTYOc5ImqGGNe9vS/fE7jKL/gzTSwwcVJ6vz8WeH/sGIwiC
OzFOHryMMJ48mHSjVikWxVWgyAFg3ojYLpNYX62QmSGp87H8qkyTC0s/qlmze1f5uPekbMwmlEZy
uD26vQC8sXdp05/XJVJft9D/2B7tGGmVlyyM52YcWILsqhGn2hqz4O/asu+OqtaxArHeBGGnwdll
7j7ftSpzGnT8VyUCQySgo73imBsJdkTfjVuVwdeGa8tl2kCQ+/WBSw27c+j2CQ47cVvqvnffGWvD
TWN7zqEtjO5nUgnpDi05YltQEX7g7dwoqIKsEnrebDvHZA8ijhsUlfAsr0l0Vmz0nGXxQpswjUpz
Mvtcbkbbl5Q9htO4B0wHyn+Sr3gmLkf/8nnzndOzDGQdA4USP+zrzj9R7a11DKCQSPwiWQx/A3y2
bGyKodvyxbatsOOto4k/puAlr/DKclnkNEEdGEAy1fd+WEi8jnEhgGHPOVdsn/nd/blqc4bTZ//y
OeeF5l7EynoTIWBLLIi+lLp357jW+uPAoW9mTo/H+WdgtozF9fd1jD8clWFUI5Vflfm+xHWMPzF1
4LmxNsXGiXr2o8GW7ILE3FJXEz7eYiX2Hqb/g6YH9vWSJegptC5zZnchfl6bLF48VHWPSKB31bzZ
XuF6ZOeOWokB7BPaIPFkfabzDftLjukFbtfyOVNjuLMxfR5nFyAWALsMvSzcKy4sbqQGfCH+jzI+
5cRXa9s7np0UAQk7vGLOHwSBPW2yeRX0/QARXpfX+vpU6YWJ7s6w3ZvmJ/saws8gfdnLzsdoYeBr
TXmCEJAD9gDPO2mXx9ZgPFnoid04/dHt3UckMITuFZnfc/CUGQtE9VRqKCfZLzH9Ssa7RHbQmfWZ
kYq8n2FmrZhOxWzhYFoc60+CHkPdhk0V1IzoyIM54LCz8Pya+3a9PmkCAIdubWuNJ3QLxtXAlGp6
HwH7kV6U7Dlc9N/ywRku4DOIUxk4Hc5icIUEz9QlOi6rlEonPA0p21zTU4ifFhirJLuwWvs8aQjh
+G0g1pfEM4UouXvGmm25oR7onZvmJ2fV0RAPCg3ybo6Hc4A/lnEm0uK61e+9fFQEhv0uIuib23q2
d9xg5v5IqNGgdrC6Vip03qCgga+QedA+sJ95Rc/UH9y5qfwt36T8Z8+N7c93zJi5tmPvMREoR25l
W5PwCyTmBsasSEwzsxpnCpArCfokuhzRPrDdMezdRH/YaQ/v6jtaX5PBR/rIJ7DNSxbGpjcfDDKH
Q6Mt5fmwJSK7MTqaj3uf4BP8P+J/ASVw7ffFYZkMAAAAAElFTkSuQmCC
"/> </g> </svg> </a> <a href=https://www.asterisk.org/blog/ target=_blank rel=noopener title=www.asterisk.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="m61.7 169.4 101.5 278C92.2 413 43.3 340.2 43.3 256c0-30.9 6.6-60.1 18.4-86.6m337.9 75.9c0-26.3-9.4-44.5-17.5-58.7-10.8-17.5-20.9-32.4-20.9-49.9 0-19.6 14.8-37.8 35.7-37.8.9 0 1.8.1 2.8.2-37.9-34.7-88.3-55.9-143.7-55.9-74.3 0-139.7 38.1-177.8 95.9 5 .2 9.7.3 13.7.3 22.2 0 56.7-2.7 56.7-2.7 11.5-.7 12.8 16.2 1.4 17.5 0 0-11.5 1.3-24.3 2l77.5 230.4L249.8 247l-33.1-90.8c-11.5-.7-22.3-2-22.3-2-11.5-.7-10.1-18.2 1.3-17.5 0 0 35.1 2.7 56 2.7 22.2 0 56.7-2.7 56.7-2.7 11.5-.7 12.8 16.2 1.4 17.5 0 0-11.5 1.3-24.3 2l76.9 228.7 21.2-70.9c9-29.4 16-50.5 16-68.7m-139.9 29.3-63.8 185.5c19.1 5.6 39.2 8.7 60.1 8.7 24.8 0 48.5-4.3 70.6-12.1-.6-.9-1.1-1.9-1.5-2.9zm183-120.7c.9 6.8 1.4 14 1.4 21.9 0 21.6-4 45.8-16.2 76.2l-65 187.9C426.2 403 468.7 334.5 468.7 256c0-37-9.4-71.8-26-102.1M8 256a248 248 0 1 1 496 0 248 248 0 1 1-496 0m484.6 0a236.6 236.6 0 1 0-473.2 0 236.6 236.6 0 1 0 473.2 0"/></svg> </a> <a href=https://twitter.com/asteriskdev target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg> </a> <a href=https://github.com/asterisk target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://community.asterisk.org target=_blank rel=noopener title=community.asterisk.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M225.9 32C103.3 32 0 130.5 0 252.1 0 256 .1 480 .1 480l225.8-.2c122.7 0 222.1-102.3 222.1-223.9S348.6 32 225.9 32M224 384c-19.4 0-37.9-4.3-54.4-12.1L88.5 392l22.9-75c-9.8-18.1-15.4-38.9-15.4-61 0-70.7 57.3-128 128-128s128 57.3 128 128-57.3 128-128 128"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.prune", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "toc.follow"], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../../../assets/javascripts/bundle.92b07e13.min.js></script> </body> </html>